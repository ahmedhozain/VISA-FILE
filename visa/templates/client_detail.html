{% extends "base.html" %}
{% block title %}ููู ุนููู{% endblock %}
{% block content %}

<!-- ุจูุงูุงุช ุงูุนููู ุงูุฃุณุงุณูุฉ -->
<div class="row g-4">
  <div class="col-lg-9">
    <div class="card shadow-lg mb-4">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-start">
          <div class="d-flex align-items-center">
            <div class="me-4">
              <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                <i class="fas fa-user fa-3x text-white"></i>
              </div>
            </div>
            <div>
              <h3 class="mb-2 text-gradient fw-bold">{{ client.name }}</h3>
              <div class="d-flex align-items-center gap-4 text-muted">
                <div class="d-flex align-items-center">
                  <i class="fas fa-phone me-2 text-primary"></i>
                  <span class="fw-semibold">{{ client.phone }}</span>
                </div>
                <div class="d-flex align-items-center">
                  <i class="fas fa-passport me-2 text-success"></i>
                  <span class="fw-semibold">{{ client.visa_type }}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="d-flex flex-column align-items-end gap-3">
                         <span class="badge bg-{{ 'success' if client.status == 'ููุชูู' else 'warning' if client.status == 'ุฌุงุฑู' else 'danger' if client.status == 'ูุฑููุถ' else 'secondary' if client.status == 'ุฑูุน ูุฑุฉ ุฃุฎุฑู' else 'dark' }} fs-6 px-4 py-2">
               <i class="fas fa-{{ 'check-circle' if client.status == 'ููุชูู' else 'clock' if client.status == 'ุฌุงุฑู' else 'times-circle' if client.status == 'ูุฑููุถ' else 'redo' if client.status == 'ุฑูุน ูุฑุฉ ุฃุฎุฑู' else 'ban' }} me-2"></i>
               {{ client.status }}
               {% if client.status == 'ุฑูุน ูุฑุฉ ุฃุฎุฑู' and client.rejection_reason %}
                 <span class="badge bg-warning text-dark ms-2">
                   <i class="fas fa-hashtag me-1"></i> {{ client.rejection_reason }}
                 </span>
               {% endif %}
             </span>
            {% if client.documents|selectattr('file_path')|list|length > 0 %}
              <a href="{{ url_for('download_all_documents', client_id=client.id) }}" class="btn btn-success btn-lg">
                <i class="fas fa-download me-2"></i> ุชูุฒูู ุฌููุน ุงููููุงุช (ZIP)
              </a>
            {% endif %}
          </div>
        </div>
        <hr>
        <div class="row text-center">
          <div class="col-md-4">
            <div class="fw-bold">ุชูููุฉ ุงููุนุงููุฉ</div>
            <div class="fs-5">{{ "{:,}".format(client.total_amount) }}</div>
          </div>
          <div class="col-md-4">
            <div class="fw-bold">ุงููุฏููุน</div>
            <div class="fs-5 text-success">{{ "{:,}".format(client.paid_sum) }}</div>
          </div>
          <div class="col-md-4">
            <div class="fw-bold">ุงููุชุจูู</div>
            <div class="fs-5 text-danger">{{ "{:,}".format(client.remaining) }}</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ุงูุจููุณ ุงูุฌุงูุจู - ุงูุฃูุฑุงู ุงููุงูุตุฉ ููุคุดุฑ ุงูุฏูุน -->
    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-warning text-dark fw-bold">
            <i class="fas fa-exclamation-triangle me-2"></i> ุงูุฃูุฑุงู ุงููุงูุตุฉ
          </div>
          <div class="card-body">
            {% if missing_required_docs %}
              <ul class="mb-0">
                {% for n in missing_required_docs %}
                  <li class="mb-2">
                    <i class="fas fa-times-circle text-danger me-2"></i>
                    {{ n }}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-success text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <p class="mb-0 fw-bold">โ ูู ุงูุฃูุฑุงู ุงูุฅุฌุจุงุฑูุฉ ููุชููุฉ</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-info text-white fw-bold">
            <i class="fas fa-chart-pie me-2"></i> ูุคุดุฑ ุงูุฏูุน
          </div>
          <div class="card-body">
            {% if client.total_amount > 0 %}
              {% set ratio = (client.paid_sum * 100) // client.total_amount %}
            {% else %}
              {% set ratio = 0 %}
            {% endif %}
            <div class="text-center mb-3">
              <div class="display-6 fw-bold text-primary">{{ ratio }}%</div>
              <div class="text-muted">ูุณุจุฉ ุงูุฅูุฌุงุฒ</div>
            </div>
            <div class="progress mb-3" role="progressbar" style="height: 25px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated" 
                   data-width="{{ ratio }}">
              </div>
            </div>
            <div class="row text-center">
              <div class="col-6">
                <div class="text-success">
                  <div class="fw-bold">{{ "{:,}".format(client.paid_sum) }}</div>
                  <small class="text-muted">ูุฏููุน</small>
                </div>
              </div>
              <div class="col-6">
                <div class="text-danger">
                  <div class="fw-bold">{{ "{:,}".format(client.remaining) }}</div>
                  <small class="text-muted">ูุชุจูู</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ุชุบููุฑ ุญุงูุฉ ุงูุนููู -->
    <div class="card shadow-lg mb-4">
      <div class="card-header bg-gradient-primary text-white fw-bold">
        <i class="fas fa-edit me-2"></i> ุชุบููุฑ ุญุงูุฉ ุงูุนููู
      </div>
      <div class="card-body p-4">
        <form method="POST" action="{{ url_for('update_client_status', client_id=client.id) }}">
          <div class="row g-4 align-items-end">
                         <div class="col-md-4">
               <label class="form-label fw-bold text-muted">ุงูุญุงูุฉ ุงูุญุงููุฉ:</label>
               <div class="mb-3">
                 <span class="badge bg-{{ 'success' if client.status == 'ููุชูู' else 'warning' if client.status == 'ุฌุงุฑู' else 'danger' if client.status == 'ูุฑููุถ' else 'secondary' if client.status == 'ุฑูุน ูุฑุฉ ุฃุฎุฑู' else 'dark' }} fs-6 px-4 py-2">
                   <i class="fas fa-{{ 'check-circle' if client.status == 'ููุชูู' else 'clock' if client.status == 'ุฌุงุฑู' else 'times-circle' if client.status == 'ูุฑููุถ' else 'redo' if client.status == 'ุฑูุน ูุฑุฉ ุฃุฎุฑู' else 'ban' }} me-2"></i>
                   {{ client.status }}
                   {% if client.status == 'ุฑูุน ูุฑุฉ ุฃุฎุฑู' and client.rejection_reason %}
                     <span class="badge bg-warning text-dark ms-2">
                       <i class="fas fa-hashtag me-1"></i> {{ client.rejection_reason }}
                     </span>
                   {% endif %}
                 </span>
               </div>
             </div>
            <div class="col-md-4">
              <label for="new_status" class="form-label fw-bold text-muted">ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ:</label>
              <select name="new_status" id="new_status" class="form-select form-select-lg" required>
                <option value="">ุงุฎุชุฑ ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ</option>
                <option value="ุฌุงุฑู" {% if client.status == 'ุฌุงุฑู' %}selected{% endif %}>ุฌุงุฑู</option>
                <option value="ููุชูู" {% if client.status == 'ููุชูู' %}selected{% endif %}>ููุชูู</option>
                <option value="ูุฑููุถ" {% if client.status == 'ูุฑููุถ' %}selected{% endif %}>ูุฑููุถ</option>
                <option value="ุฑูุน ูุฑุฉ ุฃุฎุฑู" {% if client.status == 'ุฑูุน ูุฑุฉ ุฃุฎุฑู' %}selected{% endif %}>ุฑูุน ูุฑุฉ ุฃุฎุฑู</option>
                <option value="ูุบุง ุงููุนุงููุฉ" {% if client.status == 'ูุบุง ุงููุนุงููุฉ' %}selected{% endif %}>ูุบุง ุงููุนุงููุฉ</option>
              </select>
            </div>
            
            <!-- ุญูู ุฑูู ุงููุฑุฉ - ูุธูุฑ ุนูุฏ ุงุฎุชูุงุฑ "ุฑูุน ูุฑุฉ ุฃุฎุฑู" -->
            <div class="col-md-4" id="reason_field" style="display: none;">
              <label for="rejection_reason" class="form-label fw-bold text-muted">
                <i class="fas fa-redo me-2 text-warning"></i> ุงูุฑูุน ูููุฑุฉ ุฑูู:
              </label>
              <div class="input-group input-group-lg">
                <input type="number" name="rejection_reason" id="rejection_reason" 
                       class="form-control form-control-lg border-2 border-warning" 
                       min="2" max="10" placeholder="2" required>
                <span class="input-group-text bg-warning text-dark fw-bold">ูุฑุฉ</span>
              </div>
              <div class="form-text text-muted mt-1">
                <i class="fas fa-info-circle me-1"></i> ุฃุฏุฎู ุฑูู ุงููุฑุฉ (ูุซุงู: 2ุ 3ุ 4...)
              </div>
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-primary btn-lg w-100">
                <i class="fas fa-save me-2"></i> ุชุญุฏูุซ ุงูุญุงูุฉ
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- ุชูุจููุงุช ุงูุฏูุนุงุช -->
    {% if pay_alerts %}
    <div class="alert alert-warning">
      <ul class="mb-0">
        {% for a in pay_alerts %}<li>{{ a }}</li>{% endfor %}
      </ul>
    </div>
    {% endif %}
    
    <!-- ุชูุจููุงุช ููุงุนูุฏ ุงูุฃูุฑุงู -->
    {% if deadline_alerts %}
    <div class="alert alert-danger border-0 mb-4">
      <div class="d-flex align-items-center mb-3">
        <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
        <h6 class="mb-0 fw-bold">ุชูุจููุงุช ููุงุนูุฏ ุงูุฃูุฑุงู</h6>
      </div>
      <div class="row">
        {% for alert in deadline_alerts %}
        <div class="col-12 mb-2">
          <div class="alert alert-{{ alert.type }} border-0 mb-2">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <i class="fas fa-{{ 'exclamation-circle' if alert.type == 'danger' else 'clock' if alert.type == 'warning' else 'info-circle' }} me-2"></i>
                {{ alert.message }}
              </div>
              <div class="d-flex gap-2">
                {% if alert.document.deadline_start and alert.document.deadline_end %}
                <span class="badge bg-secondary">
                  <i class="fas fa-calendar me-1"></i>
                  {{ alert.document.deadline_start.strftime('%Y-%m-%d') }} - {{ alert.document.deadline_end.strftime('%Y-%m-%d') }}
                </span>
                {% endif %}
                <a href="#document-{{ alert.document.id }}" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-eye me-1"></i>
                  ุนุฑุถ ุงููุซููุฉ
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

        <!-- ูุณู ุงูุฏูุนุงุช -->
    <div class="card shadow-lg mb-4">
      <div class="card-header bg-gradient-primary text-white fw-bold">
        <i class="fas fa-money-bill-wave me-2"></i> ุฅุฏุงุฑุฉ ุงูุฏูุนุงุช
      </div>
      <div class="card-body p-4">
                 <!-- ูููุฐุฌ ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ -->
         <form method="POST" action="{{ url_for('add_payment', client_id=client.id) }}">
           <div class="row g-4 mb-4">
             <div class="col-12">
               <h5 class="text-primary mb-4 fw-bold">
                 <i class="fas fa-plus-circle me-2"></i> ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ
               </h5>
             </div>
           
           <!-- ููุน ุงูุฏูุนุฉ -->
           <div class="col-md-3">
             <label class="form-label fw-bold fs-5 mb-2">
               <i class="fas fa-tag me-2 text-primary"></i> ููุน ุงูุฏูุนุฉ
             </label>
             <select name="payment_type" id="payment_type" class="form-select form-select-lg border-2 border-primary" required>
               <option value="ุฏูุนุฉ">๐ณ ุฏูุนุฉ</option>
               <option value="ุฑุณูู ุณูุงุฑุฉ">๐๏ธ ุฑุณูู ุณูุงุฑุฉ</option>
             </select>
             <div class="form-text text-muted mt-1">
               <i class="fas fa-info-circle me-1"></i> 
               <span id="payment_type_help">ุงูุฏูุนุฉ ุชุฎุตู ูู ุงููุจูุบ ุงูููู</span>
             </div>
           </div>
           
           <!-- ุงููุจูุบ -->
           <div class="col-md-3">
             <label class="form-label fw-bold fs-5 mb-2">
               <i class="fas fa-money-bill-wave me-2 text-success"></i> ุงููุจูุบ
             </label>
             <div class="input-group input-group-lg border-2 border-success">
               <input id="amount" name="amount" type="number" min="1" class="form-control form-control-lg" placeholder="ุฃุฏุฎู ุงููุจูุบ" required>
               <span class="input-group-text bg-success text-white fw-bold">ุฌ.ู</span>
             </div>
             <div class="form-text text-muted mt-1">
               <i class="fas fa-info-circle me-1"></i> ุงููุชุจูู ุณูุธูุฑ ุชููุงุฆููุง ุจุงูุฃุณูู
             </div>
           </div>
           
           <!-- ุชุงุฑูุฎ ุงูุฏูุน -->
           <div class="col-md-3">
             <label class="form-label fw-bold fs-5 mb-2">
               <i class="fas fa-calendar-check me-2 text-info"></i> ุชุงุฑูุฎ ุงูุฏูุน
             </label>
             <input name="paid_date" type="date" class="form-control form-control-lg border-2 border-info">
             <div class="form-check mt-3">
               <input class="form-check-input" type="checkbox" name="paid_now" id="paid_now" style="transform: scale(1.5);">
               <label class="form-check-label text-success fw-bold fs-6 ms-2" for="paid_now">
                 <i class="fas fa-check-circle me-1"></i> ุณุฌูููุง ูุฏููุนุฉ ุงูุขู
               </label>
             </div>
           </div>
           
           <!-- ุชุงุฑูุฎ ุงูุฏูุนุฉ ุงููุงุฏูุฉ -->
           <div class="col-md-3">
             <label class="form-label fw-bold fs-5 mb-2">
               <i class="fas fa-calendar-alt me-2 text-warning"></i> ุชุงุฑูุฎ ุงูุฏูุนุฉ ุงููุงุฏูุฉ
             </label>
             <input name="next_due_date" type="date" class="form-control form-control-lg border-2 border-warning">
             <div class="form-text text-muted mt-1">
               <i class="fas fa-clock me-1"></i> ุงุฎุชูุงุฑู - ููุฏูุนุงุช ุงููุฌุฏููุฉ
             </div>
           </div>
           
           <!-- ุฒุฑ ุงูุฅุถุงูุฉ -->
           <div class="col-12 text-center mt-4">
             <button type="submit" class="btn btn-primary btn-lg px-5 py-3 fw-bold fs-5">
               <i class="fas fa-plus-circle me-3"></i> ุฅุถุงูุฉ ุงูุฏูุนุฉ
             </button>
           </div>
         </div>
         </form>

                 <!-- ุนุฑุถ ุงููุชุจูู ุงููุชููุน -->
         <div class="alert alert-info border-0 mb-4">
           <div class="d-flex align-items-center">
             <i class="fas fa-calculator me-3 fa-2x"></i>
             <div>
               <strong>ุงููุชุจูู ุงููุชููุน ุจุนุฏ ูุฐู ุงูุฏูุนุฉ:</strong>
               <span class="fs-5 fw-bold text-primary ms-2" id="remaining_preview">{{ "{:,}".format(client.remaining) }}</span>
               <span class="text-muted ms-2">ุฌ.ู</span>
               <div class="text-muted small mt-1" id="payment_note">
                 <i class="fas fa-info-circle me-1"></i> 
                 <span id="note_text">ุงุฎุชุฑ ููุน ุงูุฏูุนุฉ ูุฑุคูุฉ ุงูุชุฃุซูุฑ ุนูู ุงููุชุจูู</span>
               </div>
               <div class="text-muted small mt-1">
                 <i class="fas fa-lightbulb me-1"></i> 
                 <strong>๐ก ุชูููุญ:</strong> 
                 <span id="payment_tip">ุงูุฏูุนุฉ ุชุฎุตู ูู ุงููุจูุบ ุงููููุ ุฑุณูู ุงูุณูุงุฑุฉ ูุง ุชุฎุตู</span>
               </div>
             </div>
           </div>
         </div>

        <hr class="my-4">

        <!-- ุฌุฏูู ุงูุฏูุนุงุช -->
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th class="text-center" style="width: 60px;">#</th>
                <th style="width: 120px;">ุงูููุน</th>
                <th style="width: 120px;">ุงููุจูุบ</th>
                <th style="width: 120px;">ุชุงุฑูุฎ ุงูุฏูุน</th>
                <th style="width: 120px;">ุชุงุฑูุฎ ูุงุฏู</th>
                <th style="width: 100px;">ุงูุญุงูุฉ</th>
                <th style="width: 150px;">ุงูุฅุฌุฑุงุกุงุช</th>
              </tr>
            </thead>
            <tbody>
            {% for p in payments %}
              {% set status_text, status_color = p.status_badge() %}
              <tr class="border-bottom">
                <td class="text-center">
                  <span class="badge bg-secondary rounded-pill fs-6">{{ p.number }}</span>
                </td>
                                 <td>
                   {% if p.payment_type == "ุฑุณูู ุณูุงุฑุฉ" %}
                     <span class="badge bg-info fs-6 px-3 py-2">
                       <i class="fas fa-building me-1"></i> ุฑุณูู ุณูุงุฑุฉ
                     </span>
                   {% else %}
                     <span class="badge bg-primary fs-6 px-3 py-2">
                       <i class="fas fa-money-bill me-1"></i> ุฏูุนุฉ
                     </span>
                   {% endif %}
                 </td>
                <td>
                  <span class="fw-bold fs-6">{{ "{:,}".format(p.amount) }}</span>
                  <span class="text-muted">ุฌ.ู</span>
                </td>
                <td>
                  {% if p.paid_date %}
                    <span class="text-success fw-semibold">{{ p.paid_date }}</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if p.next_due_date %}
                    <span class="fw-semibold">{{ p.next_due_date }}</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-{{ status_color }} fs-6 px-3 py-2">
                    {% if status_text == "ูุฏููุนุฉ" %}
                      <i class="fas fa-check-circle me-1"></i>
                    {% elif status_text == "ูุชุฃุฎุฑุฉ" %}
                      <i class="fas fa-exclamation-triangle me-1"></i>
                    {% elif status_text == "ุงูุชุฑุจ ุงูููุนุฏ" %}
                      <i class="fas fa-clock me-1"></i>
                    {% endif %}
                    {{ status_text }}
                  </span>
                </td>
                <td>
                  <div class="d-flex gap-2">
                    {% if not p.is_paid %}
                      <form method="post" action="{{ url_for('mark_payment_paid', client_id=client.id, payment_id=p.id) }}" class="d-inline">
                        <button class="btn btn-sm btn-success" title="ุชุณุฌูู ููุฏููุนุฉ">
                          <i class="fas fa-check"></i>
                        </button>
                      </form>
                    {% endif %}
                    <form method="post" action="{{ url_for('delete_payment', client_id=client.id, payment_id=p.id) }}" 
                          onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงูุฏูุนุฉุ')" class="d-inline">
                      <button type="submit" class="btn btn-sm btn-outline-danger" title="ุญุฐู ุงูุฏูุนุฉ">
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="7" class="text-center py-5">
                  <div class="text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p class="fs-5">ูุง ุชูุฌุฏ ุฏูุนุงุช ุจุนุฏ</p>
                    <p class="text-muted">ุงุจุฏุฃ ุจุฅุถุงูุฉ ุฃูู ุฏูุนุฉ ุจุงุณุชุฎุฏุงู ุงููููุฐุฌ ุฃุนูุงู</p>
                  </div>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    </div>



    <!-- ูููุฐุฌ ุฅุถุงูุฉ ูุซุงุฆู ุฌุฏูุฏุฉ -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
          <i class="fas fa-plus-circle me-2"></i>
          ุฅุถุงูุฉ ูุซููุฉ ุฌุฏูุฏุฉ
        </h6>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('add_custom_document', client_id=client.id) }}" class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label fw-bold">ุงุณู ุงููุซููุฉ</label>
            <input type="text" name="doc_name" class="form-control" placeholder="ูุซุงู: ุดูุงุฏุฉ ุงููููุงุฏุ ุนูุฏ ุงูุฅูุฌุงุฑ..." required>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="is_required" id="is_required">
              <label class="form-check-label fw-bold" for="is_required">
                ูุซููุฉ ุฅุฌุจุงุฑูุฉ
              </label>
            </div>
            <small class="text-muted">ุฅุฐุง ูู ูุชู ุชุญุฏูุฏูุงุ ุณุชููู ุงุฎุชูุงุฑูุฉ</small>
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-plus me-2"></i>
              ุฅุถุงูุฉ ุงููุซููุฉ
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- ูุณู ุงููุณุชูุฏุงุช -->
    <div class="card shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-bold">ุงูุฃูุฑุงู ุงูุฅุฌุจุงุฑูุฉ</span>
        {% if client.documents|selectattr('file_path')|list|length > 0 %}
          <a href="{{ url_for('download_all_documents', client_id=client.id) }}" class="btn btn-success btn-sm">
            <i class="fas fa-download"></i> ุชูุฒูู ุฌููุน ุงููููุงุช
          </a>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>ุงููุฑูุฉ</th>
                <th>ุงูุญุงูุฉ</th>
                <th>ุงูููุงุนูุฏ ุงูููุงุฆูุฉ</th>
                <th>ุงูููู</th>
                <th>ุฅุฌุฑุงุก</th>
              </tr>
            </thead>
            <tbody>
              {% for d in docs_required %}
              <tr id="document-{{ d.id }}">
                <td>
                  {{ d.name }}
                  {% if d.name not in ['ุฌูุงุฒ ุงูุณูุฑ', 'ุงูุจุทุงูุฉ ุงูุดุฎุตูุฉ', 'ุฎุทุงุจ ุงูุฏุนูุฉ', 'ุงูููุฏ ุงูุนุงุฆูู/ุงููุฑุฏู', 'ูุดู ุงูุญุณุงุจ ุงูุจููู', 'ุฅุซุจุงุช ุงููุธููุฉ', 'ุดูุงุฏุฉ ุงูุฌูุด', 'ุงูููุฑู', 'ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ', 'ุณุฌู ุงูุนูู ูุขุฎุฑ 10 ุณููุงุช', 'ุดูุงุฏุฉ ุงูุชุฎุฑุฌ', 'ุดูุงุฏุฉ ุงูุชุญุฑูุงุช', 'ุนููุฏ ุงูููููุฉ', 'ุฅุซุจุงุช ููุฏ ุงูุฃููุงุฏ'] %}
                    <span class="badge bg-info ms-2">ูุฎุตุตุฉ</span>
                  {% endif %}
                </td>
                <td>
                  {% if d.status == "ููุชููุฉ" %}
                    <span class="badge bg-success">ููุชููุฉ</span>
                  {% else %}
                    <span class="badge bg-danger">ูุงูุตุฉ</span>
                  {% endif %}
                </td>
                <td>
                  {% if d.deadline_start and d.deadline_end %}
                    {% set deadline_status, deadline_color = d.get_deadline_status() %}
                    <div class="mb-2">
                      <span class="badge bg-{{ deadline_color }} mb-2">
                        <i class="fas fa-{{ 'exclamation-circle' if deadline_color == 'danger' else 'clock' if deadline_color == 'warning' else 'info-circle' }} me-1"></i>
                        {{ deadline_status }}
                      </span>
                    </div>
                    <div class="small text-muted">
                      <div><i class="fas fa-calendar me-1"></i> {{ d.deadline_start.strftime('%Y-%m-%d') }}</div>
                      <div><i class="fas fa-calendar-times me-1"></i> {{ d.deadline_end.strftime('%Y-%m-%d') }}</div>
                    </div>
                    {% if d.deadline_start and d.deadline_end %}
                    <div class="progress mt-2" style="height: 8px;">
                      <div class="progress-bar bg-{{ deadline_color }}" style="width: {{ d.get_deadline_progress() }}%"></div>
                    </div>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">ุจุฏูู ููุนุฏ ููุงุฆู</span>
                  {% endif %}
                </td>
                <td>
                  {% set has_db_file = d.file_bytes is not none and d.file_size %}
                  {% set show_ext_name = d.file_name if d.file_name else d.file_path %}
                  {% if has_db_file or d.file_path %}
                    {% set basis = show_ext_name or '' %}
                    {% set file_extension = basis.split('.')[-1]|lower if '.' in basis else '' %}
                    {% if file_extension == 'pdf' %}
                      <div class="d-flex gap-1">
                        {% if has_db_file %}
                          <a href="{{ url_for('view_document_by_id', doc_id=d.id) }}" target="_blank" class="btn btn-sm btn-danger">
                            <i class="fas fa-eye me-1"></i> ุนุฑุถ
                          </a>
                          <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-download me-1"></i> ุชุญููู
                          </a>
                        {% else %}
                          <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'pdf')" class="btn btn-sm btn-danger">
                          <i class="fas fa-eye me-1"></i> ุนุฑุถ
                          </button>
                          <a href="{{ url_for('download_pdf', filename=d.file_path) }}" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-download me-1"></i> ุชุญููู
                          </a>
                        {% endif %}
                      </div>
                    {% elif file_extension in ['jpg', 'jpeg', 'png', 'gif'] %}
                      <div class="d-flex gap-1">
                        {% if has_db_file %}
                          <a href="{{ url_for('view_document_by_id', doc_id=d.id) }}" target="_blank" class="btn btn-sm btn-info">
                            <i class="fas fa-eye me-1"></i> ุนุฑุถ
                          </a>
                          <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-download me-1"></i> ุชุญููู
                          </a>
                        {% else %}
                          <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'image')" class="btn btn-sm btn-info">
                            <i class="fas fa-eye me-1"></i> ุนุฑุถ
                          </button>
                          <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-download me-1"></i> ุชุญููู
                          </a>
                        {% endif %}
                      </div>
                    {% elif file_extension in ['doc', 'docx'] %}
                      <div class="d-flex gap-1">
                        {% if has_db_file %}
                          <a href="{{ url_for('view_document_by_id', doc_id=d.id) }}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye me-1"></i> ุนุฑุถ
                          </a>
                          <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download me-1"></i> ุชุญููู
                          </a>
                        {% else %}
                          <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'document')" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye me-1"></i> ุนุฑุถ
                          </button>
                          <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download me-1"></i> ุชุญููู
                          </a>
                        {% endif %}
                      </div>
                    {% elif file_extension in ['xls', 'xlsx'] %}
                      <div class="d-flex gap-1">
                        {% if has_db_file %}
                          <a href="{{ url_for('view_document_by_id', doc_id=d.id) }}" target="_blank" class="btn btn-sm btn-success">
                            <i class="fas fa-eye me-1"></i> ุนุฑุถ
                          </a>
                          <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-download me-1"></i> ุชุญููู
                          </a>
                        {% else %}
                          <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'document')" class="btn btn-sm btn-success">
                            <i class="fas fa-eye me-1"></i> ุนุฑุถ
                          </button>
                          <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-download me-1"></i> ุชุญููู
                          </a>
                        {% endif %}
                      </div>
                    {% else %}
                      {% if has_db_file %}
                        <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-secondary">
                          <i class="fas fa-file me-1"></i> ุชุญููู ุงูููู
                        </a>
                      {% else %}
                        <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'other')" class="btn btn-sm btn-secondary">
                          <i class="fas fa-file me-1"></i> ุนุฑุถ ุงูููู
                        </button>
                      {% endif %}
                    {% endif %}
                  {% else %}-{% endif %}
                </td>
                <td>
                  <div class="d-flex flex-column gap-2">
                    <!-- ุฃุฒุฑุงุฑ ุฅุฏุงุฑุฉ ุงูููุงุนูุฏ ุงูููุงุฆูุฉ -->
                    <div class="d-flex gap-1 mb-2">
                      {% if d.deadline_start and d.deadline_end %}
                        <button class="btn btn-sm btn-outline-warning" onclick="editDeadline({{ d.id }}, '{{ d.deadline_start.strftime('%Y-%m-%d') }}', '{{ d.deadline_end.strftime('%Y-%m-%d') }}', {{ d.deadline_warning_days }})">
                          <i class="fas fa-edit me-1"></i> ุชุนุฏูู ุงูููุนุฏ
                        </button>
                        <form method="post" action="{{ url_for('remove_document_deadline', client_id=client.id, doc_id=d.id) }}" 
                              onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅุฒุงูุฉ ุงูููุนุฏ ุงูููุงุฆูุ')" class="d-inline">
                          <button type="submit" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-times me-1"></i> ุฅุฒุงูุฉ ุงูููุนุฏ
                          </button>
                        </form>
                      {% else %}
                        <button class="btn btn-sm btn-outline-success" onclick="setDeadline({{ d.id }})">
                          <i class="fas fa-calendar-plus me-1"></i> ุชุนููู ููุนุฏ
                        </button>
                      {% endif %}
                    </div>
                    
                    <!-- ุฃุฒุฑุงุฑ ุฑูุน ุงููููุงุช -->
                    <div class="d-flex gap-2">
                      <form method="post" action="{{ url_for('upload_document', client_id=client.id, doc_id=d.id) }}" enctype="multipart/form-data" class="d-flex gap-2">
                        <input type="file" name="file" class="form-control form-control-sm" required>
                        <button class="btn btn-sm btn-primary">ุฑูุน/ุงุณุชุจุฏุงู</button>
                      </form>
                      {% if d.file_bytes or d.file_path %}
                        {% if d.file_bytes %}
                        <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-outline-success">ุชุญููู</a>
                        {% endif %}
                        <form method="post" action="{{ url_for('delete_document', client_id=client.id, doc_id=d.id) }}" 
                              onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููููุ')" class="d-inline">
                          <button type="submit" class="btn btn-sm btn-danger">ุญุฐู ุงูููู</button>
                        </form>
                      {% endif %}
                    </div>
                    
                    <!-- ุฒุฑ ุญุฐู ุงููุซููุฉ ุงููุฎุตุตุฉ -->
                    {% if d.name not in ['ุฌูุงุฒ ุงูุณูุฑ', 'ุงูุจุทุงูุฉ ุงูุดุฎุตูุฉ', 'ุฎุทุงุจ ุงูุฏุนูุฉ', 'ุงูููุฏ ุงูุนุงุฆูู/ุงููุฑุฏู', 'ูุดู ุงูุญุณุงุจ ุงูุจููู', 'ุฅุซุจุงุช ุงููุธููุฉ', 'ุดูุงุฏุฉ ุงูุฌูุด', 'ุงูููุฑู', 'ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ', 'ุณุฌู ุงูุนูู ูุขุฎุฑ 10 ุณููุงุช', 'ุดูุงุฏุฉ ุงูุชุฎุฑุฌ', 'ุดูุงุฏุฉ ุงูุชุญุฑูุงุช', 'ุนููุฏ ุงูููููุฉ', 'ุฅุซุจุงุช ููุฏ ุงูุฃููุงุฏ'] %}
                      <form method="post" action="{{ url_for('delete_custom_document', client_id=client.id, doc_id=d.id) }}" 
                            onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงููุซููุฉุ')" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          <i class="fas fa-trash me-1"></i> ุญุฐู ุงููุซููุฉ
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-bold">ุงูุฃูุฑุงู ุงูุงุฎุชูุงุฑูุฉ</span>
        {% if client.documents|selectattr('file_path')|list|length > 0 %}
          <a href="{{ url_for('download_all_documents', client_id=client.id) }}" class="btn btn-success btn-sm">
            <i class="fas fa-download"></i> ุชูุฒูู ุฌููุน ุงููููุงุช
          </a>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>ุงููุฑูุฉ</th>
                <th>ุงูุญุงูุฉ</th>
                <th>ุงูููุงุนูุฏ ุงูููุงุฆูุฉ</th>
                <th>ุงูููู</th>
                <th>ุฅุฌุฑุงุก</th>
              </tr>
            </thead>
            <tbody>
              {% for d in docs_optional %}
              <tr id="document-{{ d.id }}">
                <td>
                  {{ d.name }}
                  {% if d.name not in ['ุฌูุงุฒ ุงูุณูุฑ', 'ุงูุจุทุงูุฉ ุงูุดุฎุตูุฉ', 'ุฎุทุงุจ ุงูุฏุนูุฉ', 'ุงูููุฏ ุงูุนุงุฆูู/ุงููุฑุฏู', 'ูุดู ุงูุญุณุงุจ ุงูุจููู', 'ุฅุซุจุงุช ุงููุธููุฉ', 'ุดูุงุฏุฉ ุงูุฌูุด', 'ุงูููุฑู', 'ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ', 'ุณุฌู ุงูุนูู ูุขุฎุฑ 10 ุณููุงุช', 'ุดูุงุฏุฉ ุงูุชุฎุฑุฌ', 'ุดูุงุฏุฉ ุงูุชุญุฑูุงุช', 'ุนููุฏ ุงูููููุฉ', 'ุฅุซุจุงุช ููุฏ ุงูุฃููุงุฏ'] %}
                    <span class="badge bg-info ms-2">ูุฎุตุตุฉ</span>
                  {% endif %}
                </td>
                <td>
                  {% if d.status == "ููุชููุฉ" %}
                    <span class="badge bg-success">ููุชููุฉ</span>
                  {% else %}
                    <span class="badge bg-secondary">ุงุฎุชูุงุฑู/ุบูุฑ ูุฑููุน</span>
                  {% endif %}
                </td>
                <td>
                  {% if d.deadline_start and d.deadline_end %}
                    {% set deadline_status, deadline_color = d.get_deadline_status() %}
                    <div class="mb-2">
                      <span class="badge bg-{{ deadline_color }} mb-2">
                        <i class="fas fa-{{ 'exclamation-circle' if deadline_color == 'danger' else 'clock' if deadline_color == 'warning' else 'info-circle' }} me-1"></i>
                        {{ deadline_status }}
                      </span>
                    </div>
                    <div class="small text-muted">
                      <div><i class="fas fa-calendar me-1"></i> {{ d.deadline_start.strftime('%Y-%m-%d') }}</div>
                      <div><i class="fas fa-calendar-times me-1"></i> {{ d.deadline_end.strftime('%Y-%m-%d') }}</div>
                    </div>
                    {% if d.deadline_start and d.deadline_end %}
                    <div class="progress mt-2" style="height: 8px;">
                      <div class="progress-bar bg-{{ deadline_color }}" style="width: {{ d.get_deadline_progress() }}%"></div>
                    </div>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">ุจุฏูู ููุนุฏ ููุงุฆู</span>
                  {% endif %}
                </td>
                <td>
                  {% if d.file_path %}
                    {% set file_extension = d.file_path.split('.')[-1]|lower if '.' in d.file_path else '' %}
                    {% if file_extension == 'pdf' %}
                      <div class="d-flex gap-1">
                        <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'pdf')" class="btn btn-sm btn-danger">
                          <i class="fas fa-eye me-1"></i> ุนุฑุถ
                        </button>
                        <a href="{{ url_for('download_pdf', filename=d.file_path) }}" class="btn btn-sm btn-outline-danger">
                          <i class="fas fa-download me-1"></i> ุชุญููู
                        </a>
                      </div>
                    {% elif file_extension in ['jpg', 'jpeg', 'png', 'gif'] %}
                      <div class="d-flex gap-1">
                        <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'image')" class="btn btn-sm btn-info">
                          <i class="fas fa-eye me-1"></i> ุนุฑุถ
                        </button>
                        <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-info">
                          <i class="fas fa-download me-1"></i> ุชุญููู
                        </a>
                      </div>
                    {% elif file_extension in ['doc', 'docx'] %}
                      <div class="d-flex gap-1">
                        <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'document')" class="btn btn-sm btn-primary">
                          <i class="fas fa-eye me-1"></i> ุนุฑุถ
                        </button>
                        <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-primary">
                          <i class="fas fa-download me-1"></i> ุชุญููู
                        </a>
                      </div>
                    {% elif file_extension in ['xls', 'xlsx'] %}
                      <div class="d-flex gap-1">
                        <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'document')" class="btn btn-sm btn-success">
                          <i class="fas fa-eye me-1"></i> ุนุฑุถ
                        </button>
                        <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-success">
                          <i class="fas fa-download me-1"></i> ุชุญููู
                        </a>
                      </div>
                    {% else %}
                      <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'other')" class="btn btn-sm btn-secondary">
                        <i class="fas fa-file me-1"></i> ุนุฑุถ ุงูููู
                      </button>
                    {% endif %}
                  {% else %}-{% endif %}
                </td>
                <td>
                  <div class="d-flex gap-2">
                    <form method="post" action="{{ url_for('upload_document', client_id=client.id, doc_id=d.id) }}" enctype="multipart/form-data" class="d-flex gap-2">
                      <input type="file" name="file" class="form-control form-control-sm" required>
                      <button class="btn btn-sm btn-primary">ุฑูุน/ุงุณุชุจุฏุงู</button>
                    </form>
                    {% if d.file_path %}
                      <form method="post" action="{{ url_for('delete_document', client_id=client.id, doc_id=d.id) }}" 
                            onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููููุ')" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-danger">ุญุฐู ุงูููู</button>
                      </form>
                    {% endif %}
                    
                    <!-- ุฒุฑ ุญุฐู ุงููุซููุฉ ุงููุฎุตุตุฉ -->
                    {% if d.name not in ['ุฌูุงุฒ ุงูุณูุฑ', 'ุงูุจุทุงูุฉ ุงูุดุฎุตูุฉ', 'ุฎุทุงุจ ุงูุฏุนูุฉ', 'ุงูููุฏ ุงูุนุงุฆูู/ุงููุฑุฏู', 'ูุดู ุงูุญุณุงุจ ุงูุจููู', 'ุฅุซุจุงุช ุงููุธููุฉ', 'ุดูุงุฏุฉ ุงูุฌูุด', 'ุงูููุฑู', 'ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ', 'ุณุฌู ุงูุนูู ูุขุฎุฑ 10 ุณููุงุช', 'ุดูุงุฏุฉ ุงูุชุฎุฑุฌ', 'ุดูุงุฏุฉ ุงูุชุญุฑูุงุช', 'ุนููุฏ ุงูููููุฉ', 'ุฅุซุจุงุช ููุฏ ุงูุฃููุงุฏ'] %}
                      <form method="post" action="{{ url_for('delete_custom_document', client_id=client.id, doc_id=d.id) }}" 
                            onsubmit="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงููุซููุฉุ')" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          <i class="fas fa-trash me-1"></i> ุญุฐู ุงููุซููุฉ
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ุงููุชุงุจุนุงุช -->
    <div class="card shadow-sm mb-4">
      <div class="card-header fw-bold">ุงููุชุงุจุนุงุช</div>
      <div class="card-body">
        <form method="post" action="{{ url_for('add_followup', client_id=client.id) }}" class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">ุชุงุฑูุฎ ุงููุชุงุจุนุฉ</label>
            <input name="follow_date" type="date" class="form-control" required>
          </div>
          <div class="col-md-7">
            <label class="form-label">ุงูููุงุญุธุงุช</label>
            <textarea name="notes" class="form-control" rows="2" required></textarea>
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100">ุญูุธ</button>
          </div>
        </form>
        <hr>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>ุงูุชุงุฑูุฎ</th>
                <th>ุงูููุงุญุธุงุช</th>
              </tr>
            </thead>
            <tbody>
              {% for f in follows %}
              <tr>
                <td>{{ f.date }}</td>
                <td>{{ f.notes }}</td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="text-center text-muted">ูุง ุชูุฌุฏ ูุชุงุจุนุงุช ุจุนุฏ.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // ุญุณุงุจ ุงููุชุจูู ุงููุชููุน ุจุนุฏ ุฅุฏุฎุงู ูุจูุบ ุงูุฏูุนุฉ
  const amountInput = document.getElementById('amount');
  const paymentTypeSelect = document.getElementById('payment_type');
  const remainingPreview = document.getElementById('remaining_preview');
  const noteText = document.getElementById('note_text');
  
  if (amountInput && remainingPreview) {
    const baseRemaining = parseInt('{{ client.remaining }}') || 0;
    const fmt = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    const paymentTypeHelp = document.getElementById('payment_type_help');
    
    function calculateRemaining() {
      const amount = parseInt(amountInput.value || '0');
      const paymentType = paymentTypeSelect ? paymentTypeSelect.value : 'ุฏูุนุฉ';
      
      let rem = baseRemaining;
      let note = '';
      let helpText = '';
      
      if (paymentType === 'ุฏูุนุฉ') {
        // ุงูุฏูุนุฉ ุชุฎุตู ูู ุงููุจูุบ ุงูููู
        rem = Math.max(baseRemaining - amount, 0);
        note = 'ุณูุชู ุฎุตู ุงููุจูุบ ูู ุงููุชุจูู';
        helpText = 'ุงูุฏูุนุฉ ุชุฎุตู ูู ุงููุจูุบ ุงูููู';
      } else if (paymentType === 'ุฑุณูู ุณูุงุฑุฉ') {
        // ุฑุณูู ุงูุณูุงุฑุฉ ูุง ุชุฎุตู ูู ุงููุจูุบ ุงูููู
        rem = baseRemaining;
        note = 'ุฑุณูู ุงูุณูุงุฑุฉ ูุง ุชุฎุตู ูู ุงููุจูุบ ุงูููู';
        helpText = 'ุฑุณูู ุงูุณูุงุฑุฉ ูุง ุชุฎุตู ูู ุงููุจูุบ ุงูููู';
      }
      
      remainingPreview.textContent = fmt(rem);
      
      // ุชุญุฏูุซ ุงููุต ุงูุชูุถูุญู
      if (noteText) {
        noteText.textContent = note;
      }
      
      // ุชุญุฏูุซ ุงููุต ุงูุชูุถูุญู ูููุน ุงูุฏูุนุฉ
      if (paymentTypeHelp) {
        paymentTypeHelp.textContent = helpText;
      }
      
      // ุชุญุฏูุซ ุงููุต ุงูุชูุถูุญู ููุชูููุญ
      const paymentTip = document.getElementById('payment_tip');
      if (paymentTip) {
        if (paymentType === 'ุฏูุนุฉ') {
          paymentTip.textContent = 'ุงูุฏูุนุฉ ุชุฎุตู ูู ุงููุจูุบ ุงูููู';
        } else if (paymentType === 'ุฑุณูู ุณูุงุฑุฉ') {
          paymentTip.textContent = 'ุฑุณูู ุงูุณูุงุฑุฉ ูุง ุชุฎุตู ูู ุงููุจูุบ ุงูููู';
        }
      }
      
      // ุชุบููุฑ ููู ุงููุชุจูู ุญุณุจ ุงููููุฉ
      if (rem === 0) {
        remainingPreview.className = 'fs-5 fw-bold text-success ms-2';
      } else if (rem < baseRemaining * 0.3) {
        remainingPreview.className = 'fs-5 fw-bold text-warning ms-2';
      } else {
        remainingPreview.className = 'fs-5 fw-bold text-primary ms-2';
      }
    }
    
    amountInput.addEventListener('input', calculateRemaining);
    
    if (paymentTypeSelect) {
      paymentTypeSelect.addEventListener('change', calculateRemaining);
    }
    
    // ุชุดุบูู ุงูุญุณุงุจ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    calculateRemaining();
  }

  // ุชุทุจูู ุนุฑุถ ุดุฑูุท ุงูุชูุฏู
  document.addEventListener('DOMContentLoaded', function() {
    // ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู ูู ูุคุดุฑ ุงูุฏูุน
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
      const ratio = progressBar.getAttribute('data-width');
      progressBar.style.width = ratio + '%';
    }
    
    // ุฅุถุงูุฉ ุชุฃุซูุฑุงุช ุจุตุฑูุฉ ููุฌุฏูู
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach((row, index) => {
      row.style.transition = 'all 0.3s ease';
      row.addEventListener('mouseenter', () => {
        row.style.transform = 'translateX(5px)';
        row.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
      });
      row.addEventListener('mouseleave', () => {
        row.style.transform = 'translateX(0)';
        row.style.boxShadow = 'none';
      });
    });
    
    // ุฅุธูุงุฑ/ุฅุฎูุงุก ุญูู ุงูุณุจุจ ุญุณุจ ุงูุญุงูุฉ ุงููุฎุชุงุฑุฉ
    const statusSelect = document.getElementById('new_status');
    const reasonField = document.getElementById('reason_field');
    const reasonTextarea = document.getElementById('rejection_reason');
    
    if (statusSelect && reasonField) {
      statusSelect.addEventListener('change', function() {
        if (this.value === 'ุฑูุน ูุฑุฉ ุฃุฎุฑู') {
          reasonField.style.display = 'block';
          reasonTextarea.setAttribute('required', 'required');
          reasonTextarea.focus();
        } else {
          reasonField.style.display = 'none';
          reasonTextarea.removeAttribute('required');
          reasonTextarea.value = '';
        }
      });
      
      // ุงูุชุญูู ูู ุงูุญุงูุฉ ุงูุญุงููุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
      if (statusSelect.value === 'ุฑูุน ูุฑุฉ ุฃุฎุฑู') {
        reasonField.style.display = 'block';
        reasonTextarea.setAttribute('required', 'required');
      }
    }
  });
</script>

<!-- Modal ูุนุฑุถ ุงููููุงุช ูู ููุณ ุงูุตูุญุฉ -->
<div class="modal fade" id="fileViewerModal" tabindex="-1" aria-labelledby="fileViewerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="fileViewerModalLabel">
          <i class="fas fa-file me-2"></i>
          <span id="modalFileName">ุนุฑุถ ุงูููู</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div id="fileViewerContent" class="w-100">
          <!-- ุณูุชู ุชุญููู ูุญุชูู ุงูููู ููุง -->
        </div>
      </div>
      <div class="modal-footer">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>
            ุฅุบูุงู
          </button>
          <a href="#" id="downloadFileBtn" class="btn btn-success" download>
            <i class="fas fa-download me-2"></i>
            ุชุญููู
          </a>
          <a href="#" id="openInNewTabBtn" class="btn btn-info" target="_blank">
            <i class="fas fa-external-link-alt me-2"></i>
            ูุชุญ ูู ูุงูุฐุฉ ุฌุฏูุฏุฉ
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal ูุฅุฏุงุฑุฉ ุงูููุงุนูุฏ ุงูููุงุฆูุฉ -->
<div class="modal fade" id="deadlineModal" tabindex="-1" aria-labelledby="deadlineModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="deadlineModalLabel">
          <i class="fas fa-calendar me-2"></i>
          ุฅุฏุงุฑุฉ ุงูููุงุนูุฏ ุงูููุงุฆูุฉ
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="deadlineForm" method="post">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="deadline_start" class="form-label fw-bold">
                <i class="fas fa-calendar-plus me-2 text-success"></i>
                ุจุฏุงูุฉ ุงููุฏุฉ
              </label>
              <input type="date" class="form-control" id="deadline_start" name="deadline_start" required>
            </div>
            <div class="col-md-6">
              <label for="deadline_end" class="form-label fw-bold">
                <i class="fas fa-calendar-times me-2 text-danger"></i>
                ููุงูุฉ ุงููุฏุฉ
              </label>
              <input type="date" class="form-control" id="deadline_end" name="deadline_end" required>
            </div>
            <div class="col-md-6">
              <label for="warning_days" class="form-label fw-bold">
                <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                ุฃูุงู ุงูุชูุจูู ุงููุจูุฑ
              </label>
              <input type="number" class="form-control" id="warning_days" name="warning_days" 
                     min="1" max="30" value="7" required>
              <div class="form-text">ุนุฏุฏ ุงูุฃูุงู ูุจู ุงูุชูุงุก ุงููุฏุฉ ูุฅุธูุงุฑ ุงูุชูุจูู</div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">
                <i class="fas fa-info-circle me-2 text-info"></i>
                ูุนูููุงุช ุงููุฏุฉ
              </label>
              <div class="alert alert-info border-0">
                <div id="deadlineInfo">
                  <i class="fas fa-lightbulb me-1"></i>
                  ุงุฎุชุฑ ุจุฏุงูุฉ ูููุงูุฉ ุงููุฏุฉ ูุฑุคูุฉ ุงููุนูููุงุช
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>
          ุฅูุบุงุก
        </button>
        <button type="submit" form="deadlineForm" class="btn btn-primary">
          <i class="fas fa-save me-2"></i>
          ุญูุธ ุงูููุนุฏ
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript ูุนุฑุถ ุงููููุงุช ูู Modal -->
<script>
function viewFileInModal(filePath, fileName, fileType) {
  const modal = new bootstrap.Modal(document.getElementById('fileViewerModal'));
  const modalTitle = document.getElementById('modalFileName');
  const modalContent = document.getElementById('fileViewerContent');
  const downloadBtn = document.getElementById('downloadFileBtn');
  const openInNewTabBtn = document.getElementById('openInNewTabBtn');
  
  // ุชุญุฏูุซ ุนููุงู Modal
  modalTitle.textContent = fileName;
  
  // ุชุญุฏูุซ ุฑูุงุจุท ุงูุฃุฒุฑุงุฑ
  downloadBtn.href = `/uploads/${filePath}`;
  openInNewTabBtn.href = `/uploads/${filePath}`;
  
  // ูุณุญ ุงููุญุชูู ุงูุณุงุจู
  modalContent.innerHTML = '';
  
  // ุนุฑุถ ุงูููู ุญุณุจ ููุนู
  if (fileType === 'pdf') {
    // ุนุฑุถ PDF
    const iframe = document.createElement('iframe');
    iframe.src = `/view_pdf/${filePath}`;
    iframe.style.width = '100%';
    iframe.style.height = '70vh';
    iframe.style.border = 'none';
    iframe.title = 'ุนุฑุถ PDF';
    modalContent.appendChild(iframe);
  } else if (fileType === 'image') {
    // ุนุฑุถ ุงูุตูุฑุฉ
    const img = document.createElement('img');
    img.src = `/view_image/${filePath}`;
    img.style.width = '100%';
    img.style.height = 'auto';
    img.style.maxHeight = '70vh';
    img.style.objectFit = 'contain';
    img.alt = fileName;
    modalContent.appendChild(img);
  } else if (fileType === 'document') {
    // ุนุฑุถ ูููุงุช Office
    const iframe = document.createElement('iframe');
    iframe.src = `/view_document/${filePath}`;
    iframe.style.width = '100%';
    iframe.style.height = '70vh';
    iframe.style.border = 'none';
    iframe.title = 'ุนุฑุถ ุงูููู';
    modalContent.appendChild(iframe);
  } else {
    // ูููููุงุช ุงูุฃุฎุฑูุ ุนุฑุถ ุฑุงุจุท ุงูุชุญููู
    const downloadDiv = document.createElement('div');
    downloadDiv.className = 'text-center p-5';
    downloadDiv.innerHTML = `
      <i class="fas fa-file fa-4x text-muted mb-3"></i>
      <h5 class="text-muted">ูุง ูููู ุนุฑุถ ูุฐุง ุงูููุน ูู ุงููููุงุช</h5>
      <p class="text-muted">ุงุถุบุท ุฒุฑ ุงูุชุญููู ูุชูุฒูู ุงูููู</p>
    `;
    modalContent.appendChild(downloadDiv);
  }
  
  // ุนุฑุถ Modal
  modal.show();
}

// ุฏุงูุฉ ูุชุญุฏูุฏ ููุน ุงูููู
function getFileType(filePath) {
  const extension = filePath.split('.').pop().toLowerCase();
  if (['pdf'].includes(extension)) return 'pdf';
  if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension)) return 'image';
  if (['doc', 'docx', 'xls', 'xlsx'].includes(extension)) return 'document';
  return 'other';
}

// ุฏูุงู ุฅุฏุงุฑุฉ ุงูููุงุนูุฏ ุงูููุงุฆูุฉ
let currentDocumentId = null;

function setDeadline(docId) {
  currentDocumentId = docId;
  const modal = new bootstrap.Modal(document.getElementById('deadlineModal'));
  const form = document.getElementById('deadlineForm');
  const startInput = document.getElementById('deadline_start');
  const endInput = document.getElementById('deadline_end');
  const warningInput = document.getElementById('warning_days');
  
  // ูุณุญ ุงููููุฐุฌ
  form.reset();
  
  // ุชุนููู ุงูุชุงุฑูุฎ ุงูุญุงูู ูุจุฏุงูุฉ ุงูุชุฑุงุถูุฉ
  const today = new Date().toISOString().split('T')[0];
  startInput.value = today;
  
  // ุชุญุฏูุซ action ูููููุฐุฌ
  form.action = `/client/{{ client.id }}/set_document_deadline/${docId}`;
  
  // ุนุฑุถ Modal
  modal.show();
  
  // ุชุญุฏูุซ ูุนูููุงุช ุงููุฏุฉ
  updateDeadlineInfo();
}

function editDeadline(docId, startDate, endDate, warningDays) {
  currentDocumentId = docId;
  const modal = new bootstrap.Modal(document.getElementById('deadlineModal'));
  const form = document.getElementById('deadlineForm');
  const startInput = document.getElementById('deadline_start');
  const endInput = document.getElementById('deadline_end');
  const warningInput = document.getElementById('warning_days');
  
  // ุชุนููู ุงูููู ุงูุญุงููุฉ
  startInput.value = startDate;
  endInput.value = endDate;
  warningInput.value = warningDays;
  
  // ุชุญุฏูุซ action ูููููุฐุฌ
  form.action = `/client/{{ client.id }}/set_document_deadline/${docId}`;
  
  // ุนุฑุถ Modal
  modal.show();
  
  // ุชุญุฏูุซ ูุนูููุงุช ุงููุฏุฉ
  updateDeadlineInfo();
}

function updateDeadlineInfo() {
  const startInput = document.getElementById('deadline_start');
  const endInput = document.getElementById('deadline_end');
  const warningInput = document.getElementById('warning_days');
  const infoDiv = document.getElementById('deadlineInfo');
  
  if (startInput.value && endInput.value) {
    const start = new Date(startInput.value);
    const end = new Date(endInput.value);
    const warning = parseInt(warningInput.value) || 7;
    
    if (start >= end) {
      infoDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-1 text-warning"></i> ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ูุฌุจ ุฃู ูููู ูุจู ุชุงุฑูุฎ ุงูููุงูุฉ';
      return;
    }
    
    const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
    const warningDate = new Date(end);
    warningDate.setDate(warningDate.getDate() - warning);
    
    infoDiv.innerHTML = `
      <div><i class="fas fa-calendar me-1"></i> <strong>ุงููุฏุฉ ุงููููุฉ:</strong> ${totalDays} ููู</div>
      <div><i class="fas fa-exclamation-triangle me-1"></i> <strong>ุงูุชูุจูู ุงููุจูุฑ:</strong> ${warningDate.toLocaleDateString('ar-EG')}</div>
      <div><i class="fas fa-clock me-1"></i> <strong>ููุงูุฉ ุงููุฏุฉ:</strong> ${end.toLocaleDateString('ar-EG')}</div>
    `;
  } else {
    infoDiv.innerHTML = '<i class="fas fa-lightbulb me-1"></i> ุงุฎุชุฑ ุจุฏุงูุฉ ูููุงูุฉ ุงููุฏุฉ ูุฑุคูุฉ ุงููุนูููุงุช';
  }
}

// ุฅุถุงูุฉ ูุณุชูุนู ุงูุฃุญุฏุงุซ
document.addEventListener('DOMContentLoaded', function() {
  const startInput = document.getElementById('deadline_start');
  const endInput = document.getElementById('deadline_end');
  const warningInput = document.getElementById('warning_days');
  
  if (startInput && endInput && warningInput) {
    startInput.addEventListener('change', updateDeadlineInfo);
    endInput.addEventListener('change', updateDeadlineInfo);
    warningInput.addEventListener('input', updateDeadlineInfo);
  }
});
</script>

{% endblock %}

