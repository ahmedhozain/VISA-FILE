{% extends "base.html" %}
{% block title %}بروفايل العميل - {{ file_client.client_name }}{% endblock %}
{% block content %}

<!-- شريط المستخدم -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card shadow-sm border-0">
      <div class="card-body py-2">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <i class="fas fa-user-circle fa-2x text-primary me-3"></i>
            <div>
              <h6 class="mb-0 text-primary">{{ session.employee_name or 'مستخدم' }}</h6>
              <small class="text-muted">{{ session.username or 'username' }}</small>
            </div>
          </div>
          <div>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">
              <i class="fas fa-sign-out-alt me-1"></i>تسجيل الخروج
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-12">
      
      <!-- رسائل التنبيه -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show mt-3" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      
      <!-- معلومات العميل الأساسية -->
      <div class="card shadow-lg border-0 mt-3 mb-4">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="fas fa-user me-2"></i>معلومات العميل الأساسية
          </h4>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="info-item">
                <label class="fw-bold text-muted">اسم العميل:</label>
                <p class="mb-0 text-primary fw-bold fs-5">{{ file_client.client_name }}</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-item">
                <label class="fw-bold text-muted">رقم الهاتف:</label>
                <p class="mb-0 text-primary fw-bold fs-5">{{ file_client.phone }}</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-item">
                <label class="fw-bold text-muted">تاريخ العقد:</label>
                <p class="mb-0">{{ file_client.contract_date.strftime('%Y-%m-%d') if file_client.contract_date else 'غير محدد' }}</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-item">
                <label class="fw-bold text-muted">المبلغ المدفوع:</label>
                <p class="mb-0 text-success fw-bold">{{ file_client.paid_amount }} ج.م</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-item">
                <label class="fw-bold text-muted">تاريخ البصمة:</label>
                <p class="mb-0">{{ file_client.fingerprint_date.strftime('%Y-%m-%d') if file_client.fingerprint_date else 'غير محدد' }}</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-item">
                <label class="fw-bold text-muted">تاريخ الرفض:</label>
                <p class="mb-0">{{ file_client.rejection_date.strftime('%Y-%m-%d') if file_client.rejection_date else 'غير محدد' }}</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-item">
                <label class="fw-bold text-muted">تاريخ التقديم للمرة الثانية:</label>
                <p class="mb-0">
                  {% if file_client.second_submission_date %}
                    <span class="badge bg-info fs-6">{{ file_client.second_submission_date.strftime('%Y-%m-%d') }}</span>
                  {% else %}
                    غير محدد
                  {% endif %}
                </p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-item">
                <label class="fw-bold text-muted">تاريخ الرفض للمرة الثانية:</label>
                <p class="mb-0">
                  {% if file_client.second_rejection_date %}
                    <span class="badge bg-warning fs-6">{{ file_client.second_rejection_date.strftime('%Y-%m-%d') }}</span>
                  {% else %}
                    غير محدد
                  {% endif %}
                </p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <label class="fw-bold text-muted">الحالة:</label>
                <p class="mb-0">
                  <span class="badge bg-{{ 'warning' if file_client.status == 'جاري' else 'success' if file_client.status == 'تم الحل' else 'danger' }} fs-6">
                    {{ file_client.status }}
                  </span>
                </p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <label class="fw-bold text-muted">أضافها:</label>
                <p class="mb-0">
                  <span class="badge bg-info fs-6">
                    {{ file_client.created_by or 'غير محدد' }}
                  </span>
                </p>
              </div>
            </div>
            <div class="col-12">
              <div class="info-item">
                <label class="fw-bold text-muted">شكوى العميل:</label>
                <p class="mb-0 bg-light p-3 rounded border-start border-4 border-primary">{{ file_client.client_complaint or 'غير محدد' }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- إضافة متابعة جديدة -->
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-warning text-dark">
          <h4 class="mb-0">
            <i class="fas fa-plus-circle me-2"></i>إضافة متابعة جديدة
          </h4>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('add_client_followup') }}">
            <input type="hidden" name="client_id" value="{{ file_client.id }}">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="date" class="form-control" id="form_received_date" name="form_received_date" required>
                  <label for="form_received_date">تاريخ استلام النموذج</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating">
                  <input type="date" class="form-control" id="client_call_date" name="client_call_date" required>
                  <label for="client_call_date">تاريخ مكالمة العميل</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" id="call_details" name="call_details" style="height: 100px" required></textarea>
                  <label for="call_details">تفاصيل المكالمة</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" id="client_complaint" name="client_complaint" style="height: 100px" required></textarea>
                  <label for="client_complaint">شكوى العميل</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-floating">
                  <textarea class="form-control" id="new_agreement" name="new_agreement" style="height: 100px" required></textarea>
                  <label for="new_agreement">الاتفاق الجديد مع العميل</label>
                </div>
              </div>
              <div class="col-12 text-center">
                <button type="submit" class="btn btn-warning btn-lg me-3">
                  <i class="fas fa-save me-2"></i>حفظ المتابعة
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- قائمة المتابعات -->
      {% if followups %}
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-info text-white">
          <h4 class="mb-0">
            <i class="fas fa-list me-2"></i>سجل المتابعات ({{ total_followups }} متابعة)
          </h4>
        </div>
        <div class="card-body">
          <div class="row g-4">
            {% for followup in followups %}
            <div class="col-12">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-dark">
                      <i class="fas fa-calendar-alt me-2"></i>متابعة رقم {{ loop.revindex }}
                    </h6>
                    <div>
                      <span class="badge bg-{{ 'success' if followup.status == 'تم' else 'warning' if followup.status == 'جاري' else 'danger' }}">
                        {{ followup.status }}
                      </span>
                      <button class="btn btn-success btn-sm ms-2" onclick="completeFollowup({{ followup.id }})">
                        <i class="fas fa-check-circle me-1"></i>إنهاء
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="info-item">
                        <label class="fw-bold text-muted">تاريخ استلام النموذج:</label>
                        <p class="mb-0">{{ followup.form_received_date.strftime('%Y-%m-%d') if followup.form_received_date else 'غير محدد' }}</p>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="info-item">
                        <label class="fw-bold text-muted">تاريخ مكالمة العميل:</label>
                        <p class="mb-0">{{ followup.client_call_date.strftime('%Y-%m-%d') if followup.client_call_date else 'غير محدد' }}</p>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="info-item">
                        <label class="fw-bold text-muted">تفاصيل المكالمة:</label>
                        <p class="mb-0 bg-light p-3 rounded border-start border-4 border-info">{{ followup.call_details or 'غير محدد' }}</p>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="info-item">
                        <label class="fw-bold text-muted">شكوى العميل:</label>
                        <p class="mb-0 bg-light p-3 rounded border-start border-4 border-danger">{{ followup.client_complaint or 'غير محدد' }}</p>
                      </div>
                    </div>
                    <div class="col-12">
                      <div class="info-item">
                        <label class="fw-bold text-muted">الاتفاق الجديد:</label>
                        <p class="mb-0 bg-light p-3 rounded border-start border-4 border-warning">{{ followup.new_agreement or 'غير محدد' }}</p>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="info-item">
                        <label class="fw-bold text-muted">أضافها:</label>
                        <p class="mb-0">
                          <span class="badge bg-secondary">{{ followup.created_by or 'غير محدد' }}</span>
                        </p>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="info-item">
                        <label class="fw-bold text-muted">تاريخ الإضافة:</label>
                        <p class="mb-0">{{ followup.created_at.strftime('%Y-%m-%d %H:%M') if followup.created_at else 'غير محدد' }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% else %}
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-body text-center py-5">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">لا توجد متابعات بعد</h5>
          <p class="text-muted">استخدم النموذج أعلاه لإضافة متابعة جديدة</p>
        </div>
      </div>
      {% endif %}

      <!-- أزرار الإجراءات -->
      <div class="text-center">
        <a href="{{ url_for('disappointed_clients') }}" class="btn btn-primary btn-lg me-3">
          <i class="fas fa-arrow-right me-2"></i>رجوع للعملاء المستاءين
        </a>
      </div>
    </div>
  </div>
</div>

<!-- نموذج إنهاء المتابعة -->
<form id="completeFollowupForm" method="POST" style="display: none;">
</form>

<script>
function completeFollowup(followupId) {
  if (confirm('هل أنت متأكد من إنهاء هذه المتابعة؟ سيتم نقل العميل إلى قائمة العملاء المكتملين.')) {
    const form = document.getElementById('completeFollowupForm');
    form.action = '/complete_client_followup/' + followupId;
    form.submit();
  }
}
</script>

<style>
.info-item {
  margin-bottom: 0.5rem;
}

.info-item label {
  font-size: 0.9rem;
  color: #6c757d;
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.info-item p {
  font-size: 1rem;
  color: #333;
  padding: 0.75rem;
  background-color: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #007bff;
  margin-bottom: 0.5rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-floating > .form-control {
  height: 58px;
  padding-top: 1.625rem;
  padding-bottom: 0.625rem;
}

.form-floating > label {
  padding: 1rem 0.75rem;
  color: #6c757d;
}

.form-floating > .form-control:focus ~ label,
.form-floating > .form-control:not(:placeholder-shown) ~ label {
  opacity: 0.65;
  transform: scale(0.85) translateY(-0.5rem) translateX(0.15rem);
}

.form-floating > .form-control:focus {
  border-color: #ffc107;
  box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
}

.card {
  border-radius: 15px;
}

.card-header {
  border-radius: 15px 15px 0 0 !important;
  border: none;
}

.btn-lg {
  padding: 0.75rem 2rem;
  border-radius: 10px;
}
</style>

{% endblock %}
