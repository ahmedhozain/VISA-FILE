{% extends "base.html" %}
{% block title %}Ù…Ù„Ù Ø¹Ù…ÙŠÙ„{% endblock %}
{% block content %}

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
<div class="row g-4">
  <div class="col-lg-9">
    <div class="card shadow-lg mb-4">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-start">
          <div class="d-flex align-items-center">
            <div class="me-4">
              <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                <i class="fas fa-user fa-3x text-white"></i>
              </div>
            </div>
            <div>
              <h3 class="mb-2 text-gradient fw-bold">{{ client.name }}</h3>
              <div class="d-flex align-items-center gap-4 text-muted">
                <div class="d-flex align-items-center">
                  <i class="fas fa-phone me-2 text-primary"></i>
                  <span class="fw-semibold">{{ client.phone }}</span>
                </div>
                <div class="d-flex align-items-center">
                  <i class="fas fa-passport me-2 text-success"></i>
                  <span class="fw-semibold">{{ client.visa_type }}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="d-flex flex-column align-items-end gap-3">
                         <span class="badge bg-{{ 'success' if client.status == 'Ù…ÙƒØªÙ…Ù„' else 'warning' if client.status == 'Ø¬Ø§Ø±ÙŠ' else 'danger' if client.status == 'Ù…Ø±ÙÙˆØ¶' else 'secondary' if client.status == 'Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' else 'dark' }} fs-6 px-4 py-2">
               <i class="fas fa-{{ 'check-circle' if client.status == 'Ù…ÙƒØªÙ…Ù„' else 'clock' if client.status == 'Ø¬Ø§Ø±ÙŠ' else 'times-circle' if client.status == 'Ù…Ø±ÙÙˆØ¶' else 'redo' if client.status == 'Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' else 'ban' }} me-2"></i>
               {{ client.status }}
               {% if client.status == 'Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' and client.rejection_reason %}
                 <span class="badge bg-warning text-dark ms-2">
                   <i class="fas fa-hashtag me-1"></i> {{ client.rejection_reason }}
                 </span>
               {% endif %}
             </span>
            {% set uploaded_docs = client.documents|selectattr('file_bytes')|list + client.documents|selectattr('file_path')|list %}
            {% if uploaded_docs|length > 0 %}
              <a href="{{ url_for('download_all_documents', client_id=client.id) }}" class="btn btn-success btn-lg">
                <i class="fas fa-download me-2"></i> ØªÙ†Ø²ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (ZIP)
                <span class="badge bg-light text-dark ms-2">{{ uploaded_docs|length }}</span>
              </a>
            {% endif %}
          </div>
        </div>
        <hr>
        <div class="row text-center">
          <div class="col-md-4">
            <div class="fw-bold">ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</div>
            <div class="fs-5">{{ "{:,}".format(client.total_amount) }}</div>
          </div>
          <div class="col-md-4">
            <div class="fw-bold">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
            <div class="fs-5 text-success">{{ "{:,}".format(client.paid_sum) }}</div>
          </div>
          <div class="col-md-4">
            <div class="fw-bold">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
            <div class="fs-5 text-danger">{{ "{:,}".format(client.remaining) }}</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Ø§Ù„Ø¨ÙˆÙƒØ³ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ - Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù†Ø§Ù‚ØµØ© ÙˆÙ…Ø¤Ø´Ø± Ø§Ù„Ø¯ÙØ¹ -->
    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-warning text-dark fw-bold">
            <i class="fas fa-exclamation-triangle me-2"></i> Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù†Ø§Ù‚ØµØ©
          </div>
          <div class="card-body">
            {% if missing_required_docs %}
              <ul class="mb-0">
                {% for n in missing_required_docs %}
                  <li class="mb-2">
                    <i class="fas fa-times-circle text-danger me-2"></i>
                    {{ n }}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-success text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <p class="mb-0 fw-bold">âœ… ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© Ù…ÙƒØªÙ…Ù„Ø©</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-info text-white fw-bold">
            <i class="fas fa-chart-pie me-2"></i> Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯ÙØ¹
          </div>
          <div class="card-body">
            {% if client.total_amount > 0 %}
              {% set ratio = (client.paid_sum * 100) // client.total_amount %}
            {% else %}
              {% set ratio = 0 %}
            {% endif %}
            <div class="text-center mb-3">
              <div class="display-6 fw-bold text-primary">{{ ratio }}%</div>
              <div class="text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
            </div>
            <div class="progress mb-3" role="progressbar" style="height: 25px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated" 
                   data-width="{{ ratio }}">
              </div>
            </div>
            <div class="row text-center">
              <div class="col-6">
                <div class="text-success">
                  <div class="fw-bold">{{ "{:,}".format(client.paid_sum) }}</div>
                  <small class="text-muted">Ù…Ø¯ÙÙˆØ¹</small>
                </div>
              </div>
              <div class="col-6">
                <div class="text-danger">
                  <div class="fw-bold">{{ "{:,}".format(client.remaining) }}</div>
                  <small class="text-muted">Ù…ØªØ¨Ù‚ÙŠ</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
    <div class="card shadow-lg mb-4">
      <div class="card-header bg-gradient-primary text-white fw-bold">
        <i class="fas fa-edit me-2"></i> ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„
      </div>
      <div class="card-body p-4">
        <form method="POST" action="{{ url_for('update_client_status', client_id=client.id) }}">
          <div class="row g-4 align-items-end">
                         <div class="col-md-4">
               <label class="form-label fw-bold text-muted">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</label>
               <div class="mb-3">
                 <span class="badge bg-{{ 'success' if client.status == 'Ù…ÙƒØªÙ…Ù„' else 'warning' if client.status == 'Ø¬Ø§Ø±ÙŠ' else 'danger' if client.status == 'Ù…Ø±ÙÙˆØ¶' else 'secondary' if client.status == 'Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' else 'dark' }} fs-6 px-4 py-2">
                   <i class="fas fa-{{ 'check-circle' if client.status == 'Ù…ÙƒØªÙ…Ù„' else 'clock' if client.status == 'Ø¬Ø§Ø±ÙŠ' else 'times-circle' if client.status == 'Ù…Ø±ÙÙˆØ¶' else 'redo' if client.status == 'Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' else 'ban' }} me-2"></i>
                   {{ client.status }}
                   {% if client.status == 'Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' and client.rejection_reason %}
                     <span class="badge bg-warning text-dark ms-2">
                       <i class="fas fa-hashtag me-1"></i> {{ client.rejection_reason }}
                     </span>
                   {% endif %}
                 </span>
               </div>
             </div>
            <div class="col-md-4">
              <label for="new_status" class="form-label fw-bold text-muted">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
              <select name="new_status" id="new_status" class="form-select form-select-lg" required>
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</option>
                <option value="Ø¬Ø§Ø±ÙŠ" {% if client.status == 'Ø¬Ø§Ø±ÙŠ' %}selected{% endif %}>Ø¬Ø§Ø±ÙŠ</option>
                <option value="Ù…ÙƒØªÙ…Ù„" {% if client.status == 'Ù…ÙƒØªÙ…Ù„' %}selected{% endif %}>Ù…ÙƒØªÙ…Ù„</option>
                <option value="Ù…Ø±ÙÙˆØ¶" {% if client.status == 'Ù…Ø±ÙÙˆØ¶' %}selected{% endif %}>Ù…Ø±ÙÙˆØ¶</option>
                <option value="Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰" {% if client.status == 'Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰' %}selected{% endif %}>Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</option>
                <option value="Ù„ØºØ§ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©" {% if client.status == 'Ù„ØºØ§ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©' %}selected{% endif %}>Ù„ØºØ§ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</option>
              </select>
            </div>
            
            <!-- Ø­Ù‚Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø© - ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰" -->
            <div class="col-md-4" id="reason_field" style="display: none;">
              <label for="rejection_reason" class="form-label fw-bold text-muted">
                <i class="fas fa-redo me-2 text-warning"></i> Ø§Ù„Ø±ÙØ¹ Ù„Ù„Ù…Ø±Ø© Ø±Ù‚Ù…:
              </label>
              <div class="input-group input-group-lg">
                <input type="number" name="rejection_reason" id="rejection_reason" 
                       class="form-control form-control-lg border-2 border-warning" 
                       min="2" max="10" placeholder="2" required>
                <span class="input-group-text bg-warning text-dark fw-bold">Ù…Ø±Ø©</span>
              </div>
              <div class="form-text text-muted mt-1">
                <i class="fas fa-info-circle me-1"></i> Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø© (Ù…Ø«Ø§Ù„: 2ØŒ 3ØŒ 4...)
              </div>
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-primary btn-lg w-100">
                <i class="fas fa-save me-2"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø§Øª -->
    {% if pay_alerts %}
    <div class="alert alert-warning">
      <ul class="mb-0">
        {% for a in pay_alerts %}<li>{{ a }}</li>{% endfor %}
      </ul>
    </div>
    {% endif %}
    
    <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ -->
    {% if deadline_alerts %}
    <div class="alert alert-danger border-0 mb-4">
      <div class="d-flex align-items-center mb-3">
        <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
        <h6 class="mb-0 fw-bold">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚</h6>
      </div>
      <div class="row">
        {% for alert in deadline_alerts %}
        <div class="col-12 mb-2">
          <div class="alert alert-{{ alert.type }} border-0 mb-2">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <i class="fas fa-{{ 'exclamation-circle' if alert.type == 'danger' else 'clock' if alert.type == 'warning' else 'info-circle' }} me-2"></i>
                {{ alert.message }}
              </div>
              <div class="d-flex gap-2">
                {% if alert.document.deadline_start and alert.document.deadline_end %}
                <span class="badge bg-secondary">
                  <i class="fas fa-calendar me-1"></i>
                  {{ alert.document.deadline_start.strftime('%Y-%m-%d') }} - {{ alert.document.deadline_end.strftime('%Y-%m-%d') }}
                </span>
                {% endif %}
                <a href="#document-{{ alert.document.id }}" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-eye me-1"></i>
                  Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
                </a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¯ÙØ¹Ø§Øª -->
    <div class="card shadow-lg mb-4">
      <div class="card-header bg-gradient-primary text-white fw-bold">
        <i class="fas fa-money-bill-wave me-2"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª
      </div>
      <div class="card-body p-4">
                 <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
         <form method="POST" action="{{ url_for('add_payment', client_id=client.id) }}">
           <div class="row g-4 mb-4">
             <div class="col-12">
               <h5 class="text-primary mb-4 fw-bold">
                 <i class="fas fa-plus-circle me-2"></i> Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
               </h5>
             </div>
           
           <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø© -->
           <div class="col-md-3">
             <label class="form-label fw-bold fs-5 mb-2">
               <i class="fas fa-tag me-2 text-primary"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©
             </label>
             <select name="payment_type" id="payment_type" class="form-select form-select-lg border-2 border-primary" required>
               <option value="Ø¯ÙØ¹Ø©">ğŸ’³ Ø¯ÙØ¹Ø©</option>
               <option value="Ø±Ø³ÙˆÙ… Ø³ÙØ§Ø±Ø©">ğŸ›ï¸ Ø±Ø³ÙˆÙ… Ø³ÙØ§Ø±Ø©</option>
             </select>
             <div class="form-text text-muted mt-1">
               <i class="fas fa-info-circle me-1"></i> 
               <span id="payment_type_help">Ø§Ù„Ø¯ÙØ¹Ø© ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</span>
             </div>
           </div>
           
           <!-- Ø§Ù„Ù…Ø¨Ù„Øº -->
           <div class="col-md-3">
             <label class="form-label fw-bold fs-5 mb-2">
               <i class="fas fa-money-bill-wave me-2 text-success"></i> Ø§Ù„Ù…Ø¨Ù„Øº
             </label>
             <div class="input-group input-group-lg border-2 border-success">
               <input id="amount" name="amount" type="number" min="1" class="form-control form-control-lg" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº" required>
               <span class="input-group-text bg-success text-white fw-bold">Ø¬.Ù…</span>
             </div>
             <div class="form-text text-muted mt-1">
               <i class="fas fa-info-circle me-1"></i> Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø³ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ø£Ø³ÙÙ„
             </div>
           </div>
           
           <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹ -->
           <div class="col-md-3">
             <label class="form-label fw-bold fs-5 mb-2">
               <i class="fas fa-calendar-check me-2 text-info"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹
             </label>
             <input name="paid_date" type="date" class="form-control form-control-lg border-2 border-info">
             <div class="form-check mt-3">
               <input class="form-check-input" type="checkbox" name="paid_now" id="paid_now" style="transform: scale(1.5);">
               <label class="form-check-label text-success fw-bold fs-6 ms-2" for="paid_now">
                 <i class="fas fa-check-circle me-1"></i> Ø³Ø¬Ù‘Ù„Ù‡Ø§ Ù…Ø¯ÙÙˆØ¹Ø© Ø§Ù„Ø¢Ù†
               </label>
             </div>
           </div>
           
           <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© -->
           <div class="col-md-3">
             <label class="form-label fw-bold fs-5 mb-2">
               <i class="fas fa-calendar-alt me-2 text-warning"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
             </label>
             <input name="next_due_date" type="date" class="form-control form-control-lg border-2 border-warning">
             <div class="form-text text-muted mt-1">
               <i class="fas fa-clock me-1"></i> Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù„Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©
             </div>
           </div>
           
           <!-- Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
           <div class="col-12 text-center mt-4">
             <button type="submit" class="btn btn-primary btn-lg px-5 py-3 fw-bold fs-5">
               <i class="fas fa-plus-circle me-3"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©
             </button>
           </div>
         </div>
         </form>

                 <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ -->
         <div class="alert alert-info border-0 mb-4">
           <div class="d-flex align-items-center">
             <i class="fas fa-calculator me-3 fa-2x"></i>
             <div>
               <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©:</strong>
               <span class="fs-5 fw-bold text-primary ms-2" id="remaining_preview">{{ "{:,}".format(client.remaining) }}</span>
               <span class="text-muted ms-2">Ø¬.Ù…</span>
               <div class="text-muted small mt-1" id="payment_note">
                 <i class="fas fa-info-circle me-1"></i> 
                 <span id="note_text">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
               </div>
               <div class="text-muted small mt-1">
                 <i class="fas fa-lightbulb me-1"></i> 
                 <strong>ğŸ’¡ ØªÙ„Ù…ÙŠØ­:</strong> 
                 <span id="payment_tip">Ø§Ù„Ø¯ÙØ¹Ø© ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠØŒ Ø±Ø³ÙˆÙ… Ø§Ù„Ø³ÙØ§Ø±Ø© Ù„Ø§ ØªØ®ØµÙ…</span>
               </div>
             </div>
           </div>
         </div>

        <hr class="my-4">

        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª -->
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th class="text-center" style="width: 60px;">#</th>
                <th style="width: 120px;">Ø§Ù„Ù†ÙˆØ¹</th>
                <th style="width: 120px;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th style="width: 120px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹</th>
                <th style="width: 120px;">ØªØ§Ø±ÙŠØ® Ù‚Ø§Ø¯Ù…</th>
                <th style="width: 100px;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th style="width: 150px;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
            {% for p in payments %}
              {% set status_text, status_color = p.status_badge() %}
              <tr class="border-bottom">
                <td class="text-center">
                  <span class="badge bg-secondary rounded-pill fs-6">{{ p.number }}</span>
                </td>
                                 <td>
                   {% if p.payment_type == "Ø±Ø³ÙˆÙ… Ø³ÙØ§Ø±Ø©" %}
                     <span class="badge bg-info fs-6 px-3 py-2">
                       <i class="fas fa-building me-1"></i> Ø±Ø³ÙˆÙ… Ø³ÙØ§Ø±Ø©
                     </span>
                   {% else %}
                     <span class="badge bg-primary fs-6 px-3 py-2">
                       <i class="fas fa-money-bill me-1"></i> Ø¯ÙØ¹Ø©
                     </span>
                   {% endif %}
                 </td>
                <td>
                  <span class="fw-bold fs-6">{{ "{:,}".format(p.amount) }}</span>
                  <span class="text-muted">Ø¬.Ù…</span>
                </td>
                <td>
                  {% if p.paid_date %}
                    <span class="text-success fw-semibold">{{ p.paid_date }}</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if p.next_due_date %}
                    <span class="fw-semibold">{{ p.next_due_date }}</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-{{ status_color }} fs-6 px-3 py-2">
                    {% if status_text == "Ù…Ø¯ÙÙˆØ¹Ø©" %}
                      <i class="fas fa-check-circle me-1"></i>
                    {% elif status_text == "Ù…ØªØ£Ø®Ø±Ø©" %}
                      <i class="fas fa-exclamation-triangle me-1"></i>
                    {% elif status_text == "Ø§Ù‚ØªØ±Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯" %}
                      <i class="fas fa-clock me-1"></i>
                    {% endif %}
                    {{ status_text }}
                  </span>
                </td>
                <td>
                  <div class="d-flex gap-2">
                    {% if not p.is_paid %}
                      <form method="post" action="{{ url_for('mark_payment_paid', client_id=client.id, payment_id=p.id) }}" class="d-inline">
                        <button class="btn btn-sm btn-success" title="ØªØ³Ø¬ÙŠÙ„ ÙƒÙ…Ø¯ÙÙˆØ¹Ø©">
                          <i class="fas fa-check"></i>
                        </button>
                      </form>
                    {% endif %}
                    <form method="post" action="{{ url_for('delete_payment', client_id=client.id, payment_id=p.id) }}" 
                          onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ')" class="d-inline">
                      <button type="submit" class="btn btn-sm btn-outline-danger" title="Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©">
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="7" class="text-center py-5">
                  <div class="text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p class="fs-5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ø¨Ø¹Ø¯</p>
                    <p class="text-muted">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø¯ÙØ¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡</p>
                  </div>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    </div>



    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ÙˆØ«Ø§Ø¦Ù‚ Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
          <i class="fas fa-plus-circle me-2"></i>
          Ø¥Ø¶Ø§ÙØ© ÙˆØ«ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </h6>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('add_custom_document', client_id=client.id) }}" class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label fw-bold">Ø§Ø³Ù… Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</label>
            <input type="text" name="doc_name" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ØŒ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±..." required>
          </div>
          <div class="col-md-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="is_required" id="is_required">
              <label class="form-check-label fw-bold" for="is_required">
                ÙˆØ«ÙŠÙ‚Ø© Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©
              </label>
            </div>
            <small class="text-muted">Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ØŒ Ø³ØªÙƒÙˆÙ† Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©</small>
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-plus me-2"></i>
              Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª -->
    <div class="card shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-bold">Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©</span>
        {% set uploaded_docs = client.documents|selectattr('file_bytes')|list + client.documents|selectattr('file_path')|list %}
        {% if uploaded_docs|length > 0 %}
          <a href="{{ url_for('download_all_documents', client_id=client.id) }}" class="btn btn-success btn-sm">
            <i class="fas fa-download me-1"></i> ØªÙ†Ø²ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
            <span class="badge bg-light text-dark ms-1">{{ uploaded_docs|length }}</span>
          </a>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Ø§Ù„ÙˆØ±Ù‚Ø©</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</th>
                <th>Ø§Ù„Ù…Ù„Ù</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody>
              {% for d in docs_required %}
              <tr id="document-{{ d.id }}">
                <td>
                  {{ d.name }}
                  {% if d.name not in ['Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±', 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©', 'Ø®Ø·Ø§Ø¨ Ø§Ù„Ø¯Ø¹ÙˆØ©', 'Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠ/Ø§Ù„ÙØ±Ø¯ÙŠ', 'ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ', 'Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ©', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¬ÙŠØ´', 'Ø§Ù„ÙÙˆØ±Ù…', 'Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©', 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ Ù„Ø¢Ø®Ø± 10 Ø³Ù†ÙˆØ§Øª', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªØ®Ø±Ø¬', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø±ÙƒØ§Øª', 'Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù„ÙƒÙŠØ©', 'Ø¥Ø«Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯'] %}
                    <span class="badge bg-info ms-2">Ù…Ø®ØµØµØ©</span>
                  {% endif %}
                </td>
                <td>
                  {% if d.status == "Ù…ÙƒØªÙ…Ù„Ø©" %}
                    <span class="badge bg-success">Ù…ÙƒØªÙ…Ù„Ø©</span>
                  {% else %}
                    <span class="badge bg-danger">Ù†Ø§Ù‚ØµØ©</span>
                  {% endif %}
                </td>
                <td>
                  {% if d.deadline_start and d.deadline_end %}
                    {% set deadline_status, deadline_color = d.get_deadline_status() %}
                    <div class="mb-2">
                      <span class="badge bg-{{ deadline_color }} mb-2">
                        <i class="fas fa-{{ 'exclamation-circle' if deadline_color == 'danger' else 'clock' if deadline_color == 'warning' else 'info-circle' }} me-1"></i>
                        {{ deadline_status }}
                      </span>
                    </div>
                    <div class="small text-muted">
                      <div><i class="fas fa-calendar me-1"></i> {{ d.deadline_start.strftime('%Y-%m-%d') }}</div>
                      <div><i class="fas fa-calendar-times me-1"></i> {{ d.deadline_end.strftime('%Y-%m-%d') }}</div>
                    </div>
                    {% if d.deadline_start and d.deadline_end %}
                    <div class="progress mt-2" style="height: 8px;">
                      <div class="progress-bar bg-{{ deadline_color }}" style="width: {{ d.get_deadline_progress() }}%"></div>
                    </div>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯ Ù†Ù‡Ø§Ø¦ÙŠ</span>
                  {% endif %}
                </td>
                <td>
                  {% set has_db_file = d.file_bytes is not none and d.file_size %}
                  {% set show_ext_name = d.file_name if d.file_name else d.file_path %}
                  {% if has_db_file or d.file_path %}
                    {% set basis = show_ext_name or '' %}
                    {% set file_extension = basis.split('.')[-1]|lower if '.' in basis else '' %}
                    {% if file_extension == 'pdf' %}
                      <div class="d-flex gap-1">
                        {% if has_db_file %}
                          <a href="{{ url_for('view_document_by_id', doc_id=d.id) }}" target="_blank" class="btn btn-sm btn-danger">
                            <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                          </a>
                          <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                          </a>
                        {% else %}
                          <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'pdf')" class="btn btn-sm btn-danger">
                          <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                          </button>
                          <a href="{{ url_for('download_pdf', filename=d.file_path) }}" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                          </a>
                        {% endif %}
                      </div>
                    {% elif file_extension in ['jpg', 'jpeg', 'png', 'gif'] %}
                      <div class="d-flex gap-1">
                        {% if has_db_file %}
                          <a href="{{ url_for('view_document_by_id', doc_id=d.id) }}" target="_blank" class="btn btn-sm btn-info">
                            <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                          </a>
                          <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                          </a>
                        {% else %}
                          <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'image')" class="btn btn-sm btn-info">
                            <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                          </button>
                          <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                          </a>
                        {% endif %}
                      </div>
                    {% elif file_extension in ['doc', 'docx'] %}
                      <div class="d-flex gap-1">
                        {% if has_db_file %}
                          <a href="{{ url_for('view_document_by_id', doc_id=d.id) }}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                          </a>
                          <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                          </a>
                        {% else %}
                          <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'document')" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                          </button>
                          <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                          </a>
                        {% endif %}
                      </div>
                    {% elif file_extension in ['xls', 'xlsx'] %}
                      <div class="d-flex gap-1">
                        {% if has_db_file %}
                          <a href="{{ url_for('view_document_by_id', doc_id=d.id) }}" target="_blank" class="btn btn-sm btn-success">
                            <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                          </a>
                          <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                          </a>
                        {% else %}
                          <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'document')" class="btn btn-sm btn-success">
                            <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                          </button>
                          <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                          </a>
                        {% endif %}
                      </div>
                    {% else %}
                      {% if has_db_file %}
                        <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-secondary">
                          <i class="fas fa-file me-1"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                        </a>
                      {% else %}
                        <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'other')" class="btn btn-sm btn-secondary">
                          <i class="fas fa-file me-1"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù
                        </button>
                      {% endif %}
                    {% endif %}
                  {% else %}-{% endif %}
                </td>
                <td>
                  <div class="d-flex flex-column gap-2">
                    <!-- Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
                    <div class="d-flex gap-1 mb-2">
                      {% if d.deadline_start and d.deadline_end %}
                        <button class="btn btn-sm btn-outline-warning" onclick="editDeadline({{ d.id }}, '{{ d.deadline_start.strftime('%Y-%m-%d') }}', '{{ d.deadline_end.strftime('%Y-%m-%d') }}', {{ d.deadline_warning_days }})">
                          <i class="fas fa-edit me-1"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯
                        </button>
                        <form method="post" action="{{ url_for('remove_document_deadline', client_id=client.id, doc_id=d.id) }}" 
                              onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ')" class="d-inline">
                          <button type="submit" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-times me-1"></i> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¹Ø¯
                          </button>
                        </form>
                      {% else %}
                        <button class="btn btn-sm btn-outline-success" onclick="setDeadline({{ d.id }})">
                          <i class="fas fa-calendar-plus me-1"></i> ØªØ¹ÙŠÙŠÙ† Ù…ÙˆØ¹Ø¯
                        </button>
                      {% endif %}
                    </div>
                    
                    <!-- Ø£Ø²Ø±Ø§Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª -->
                    <div class="d-flex gap-2">
                      <form method="post" action="{{ url_for('upload_document', client_id=client.id, doc_id=d.id) }}" enctype="multipart/form-data" class="d-flex gap-2">
                        <input type="file" name="file" class="form-control form-control-sm" required>
                        <button class="btn btn-sm btn-primary">Ø±ÙØ¹/Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button>
                      </form>
                      {% if d.file_bytes or d.file_path %}
                        {% if d.file_bytes %}
                        <a href="{{ url_for('download_document_by_id', doc_id=d.id) }}" class="btn btn-sm btn-outline-success">ØªØ­Ù…ÙŠÙ„</a>
                        {% endif %}
                        <form method="post" action="{{ url_for('delete_document', client_id=client.id, doc_id=d.id) }}" 
                              onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ')" class="d-inline">
                          <button type="submit" class="btn btn-sm btn-danger">Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù</button>
                        </form>
                      {% endif %}
                    </div>
                    
                    <!-- Ø²Ø± Ø­Ø°Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø®ØµØµØ© -->
                    {% if d.name not in ['Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±', 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©', 'Ø®Ø·Ø§Ø¨ Ø§Ù„Ø¯Ø¹ÙˆØ©', 'Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠ/Ø§Ù„ÙØ±Ø¯ÙŠ', 'ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ', 'Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ©', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¬ÙŠØ´', 'Ø§Ù„ÙÙˆØ±Ù…', 'Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©', 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ Ù„Ø¢Ø®Ø± 10 Ø³Ù†ÙˆØ§Øª', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªØ®Ø±Ø¬', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø±ÙƒØ§Øª', 'Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù„ÙƒÙŠØ©', 'Ø¥Ø«Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯'] %}
                      <form method="post" action="{{ url_for('delete_custom_document', client_id=client.id, doc_id=d.id) }}" 
                            onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©ØŸ')" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          <i class="fas fa-trash me-1"></i> Ø­Ø°Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-bold">Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©</span>
        {% set uploaded_docs = client.documents|selectattr('file_bytes')|list + client.documents|selectattr('file_path')|list %}
        {% if uploaded_docs|length > 0 %}
          <a href="{{ url_for('download_all_documents', client_id=client.id) }}" class="btn btn-success btn-sm">
            <i class="fas fa-download me-1"></i> ØªÙ†Ø²ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
            <span class="badge bg-light text-dark ms-1">{{ uploaded_docs|length }}</span>
          </a>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Ø§Ù„ÙˆØ±Ù‚Ø©</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</th>
                <th>Ø§Ù„Ù…Ù„Ù</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody>
              {% for d in docs_optional %}
              <tr id="document-{{ d.id }}">
                <td>
                  {{ d.name }}
                  {% if d.name not in ['Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±', 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©', 'Ø®Ø·Ø§Ø¨ Ø§Ù„Ø¯Ø¹ÙˆØ©', 'Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠ/Ø§Ù„ÙØ±Ø¯ÙŠ', 'ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ', 'Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ©', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¬ÙŠØ´', 'Ø§Ù„ÙÙˆØ±Ù…', 'Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©', 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ Ù„Ø¢Ø®Ø± 10 Ø³Ù†ÙˆØ§Øª', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªØ®Ø±Ø¬', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø±ÙƒØ§Øª', 'Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù„ÙƒÙŠØ©', 'Ø¥Ø«Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯'] %}
                    <span class="badge bg-info ms-2">Ù…Ø®ØµØµØ©</span>
                  {% endif %}
                </td>
                <td>
                  {% if d.status == "Ù…ÙƒØªÙ…Ù„Ø©" %}
                    <span class="badge bg-success">Ù…ÙƒØªÙ…Ù„Ø©</span>
                  {% else %}
                    <span class="badge bg-secondary">Ø§Ø®ØªÙŠØ§Ø±ÙŠ/ØºÙŠØ± Ù…Ø±ÙÙˆØ¹</span>
                  {% endif %}
                </td>
                <td>
                  {% if d.deadline_start and d.deadline_end %}
                    {% set deadline_status, deadline_color = d.get_deadline_status() %}
                    <div class="mb-2">
                      <span class="badge bg-{{ deadline_color }} mb-2">
                        <i class="fas fa-{{ 'exclamation-circle' if deadline_color == 'danger' else 'clock' if deadline_color == 'warning' else 'info-circle' }} me-1"></i>
                        {{ deadline_status }}
                      </span>
                    </div>
                    <div class="small text-muted">
                      <div><i class="fas fa-calendar me-1"></i> {{ d.deadline_start.strftime('%Y-%m-%d') }}</div>
                      <div><i class="fas fa-calendar-times me-1"></i> {{ d.deadline_end.strftime('%Y-%m-%d') }}</div>
                    </div>
                    {% if d.deadline_start and d.deadline_end %}
                    <div class="progress mt-2" style="height: 8px;">
                      <div class="progress-bar bg-{{ deadline_color }}" style="width: {{ d.get_deadline_progress() }}%"></div>
                    </div>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¹Ø¯ Ù†Ù‡Ø§Ø¦ÙŠ</span>
                  {% endif %}
                </td>
                <td>
                  {% if d.file_path %}
                    {% set file_extension = d.file_path.split('.')[-1]|lower if '.' in d.file_path else '' %}
                    {% if file_extension == 'pdf' %}
                      <div class="d-flex gap-1">
                        <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'pdf')" class="btn btn-sm btn-danger">
                          <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                        </button>
                        <a href="{{ url_for('download_pdf', filename=d.file_path) }}" class="btn btn-sm btn-outline-danger">
                          <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                        </a>
                      </div>
                    {% elif file_extension in ['jpg', 'jpeg', 'png', 'gif'] %}
                      <div class="d-flex gap-1">
                        <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'image')" class="btn btn-sm btn-info">
                          <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                        </button>
                        <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-info">
                          <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                        </a>
                      </div>
                    {% elif file_extension in ['doc', 'docx'] %}
                      <div class="d-flex gap-1">
                        <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'document')" class="btn btn-sm btn-primary">
                          <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                        </button>
                        <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-primary">
                          <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                        </a>
                      </div>
                    {% elif file_extension in ['xls', 'xlsx'] %}
                      <div class="d-flex gap-1">
                        <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'document')" class="btn btn-sm btn-success">
                          <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                        </button>
                        <a href="{{ url_for('uploaded_file', filename=d.file_path) }}" class="btn btn-sm btn-outline-success">
                          <i class="fas fa-download me-1"></i> ØªØ­Ù…ÙŠÙ„
                        </a>
                      </div>
                    {% else %}
                      <button onclick="viewFileInModal('{{ d.file_path }}', '{{ d.name }}', 'other')" class="btn btn-sm btn-secondary">
                        <i class="fas fa-file me-1"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù
                      </button>
                    {% endif %}
                  {% else %}-{% endif %}
                </td>
                <td>
                  <div class="d-flex gap-2">
                    <form method="post" action="{{ url_for('upload_document', client_id=client.id, doc_id=d.id) }}" enctype="multipart/form-data" class="d-flex gap-2">
                      <input type="file" name="file" class="form-control form-control-sm" required>
                      <button class="btn btn-sm btn-primary">Ø±ÙØ¹/Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button>
                    </form>
                    {% if d.file_path %}
                      <form method="post" action="{{ url_for('delete_document', client_id=client.id, doc_id=d.id) }}" 
                            onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ')" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-danger">Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù</button>
                      </form>
                    {% endif %}
                    
                    <!-- Ø²Ø± Ø­Ø°Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø®ØµØµØ© -->
                    {% if d.name not in ['Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±', 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©', 'Ø®Ø·Ø§Ø¨ Ø§Ù„Ø¯Ø¹ÙˆØ©', 'Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠ/Ø§Ù„ÙØ±Ø¯ÙŠ', 'ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ', 'Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ©', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¬ÙŠØ´', 'Ø§Ù„ÙÙˆØ±Ù…', 'Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©', 'Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ Ù„Ø¢Ø®Ø± 10 Ø³Ù†ÙˆØ§Øª', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªØ®Ø±Ø¬', 'Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø±ÙƒØ§Øª', 'Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù„ÙƒÙŠØ©', 'Ø¥Ø«Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ø§Ø¯'] %}
                      <form method="post" action="{{ url_for('delete_custom_document', client_id=client.id, doc_id=d.id) }}" 
                            onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©ØŸ')" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                          <i class="fas fa-trash me-1"></i> Ø­Ø°Ù Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
                        </button>
                      </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª -->
    <div class="card shadow-sm mb-4">
      <div class="card-header fw-bold">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø§Øª</div>
      <div class="card-body">
        <form method="post" action="{{ url_for('add_followup', client_id=client.id) }}" class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</label>
            <input name="follow_date" type="date" class="form-control" required>
          </div>
          <div class="col-md-7">
            <label class="form-label">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea name="notes" class="form-control" rows="2" required></textarea>
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100">Ø­ÙØ¸</button>
          </div>
        </form>
        <hr>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
              {% for f in follows %}
              <tr>
                <td>{{ f.date }}</td>
                <td>{{ f.notes }}</td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ§Ø¨Ø¹Ø§Øª Ø¨Ø¹Ø¯.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©
  const amountInput = document.getElementById('amount');
  const paymentTypeSelect = document.getElementById('payment_type');
  const remainingPreview = document.getElementById('remaining_preview');
  const noteText = document.getElementById('note_text');
  
  if (amountInput && remainingPreview) {
    const baseRemaining = parseInt('{{ client.remaining }}') || 0;
    const fmt = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    const paymentTypeHelp = document.getElementById('payment_type_help');
    
    function calculateRemaining() {
      const amount = parseInt(amountInput.value || '0');
      const paymentType = paymentTypeSelect ? paymentTypeSelect.value : 'Ø¯ÙØ¹Ø©';
      
      let rem = baseRemaining;
      let note = '';
      let helpText = '';
      
      if (paymentType === 'Ø¯ÙØ¹Ø©') {
        // Ø§Ù„Ø¯ÙØ¹Ø© ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ
        rem = Math.max(baseRemaining - amount, 0);
        note = 'Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ';
        helpText = 'Ø§Ù„Ø¯ÙØ¹Ø© ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ';
      } else if (paymentType === 'Ø±Ø³ÙˆÙ… Ø³ÙØ§Ø±Ø©') {
        // Ø±Ø³ÙˆÙ… Ø§Ù„Ø³ÙØ§Ø±Ø© Ù„Ø§ ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ
        rem = baseRemaining;
        note = 'Ø±Ø³ÙˆÙ… Ø§Ù„Ø³ÙØ§Ø±Ø© Ù„Ø§ ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ';
        helpText = 'Ø±Ø³ÙˆÙ… Ø§Ù„Ø³ÙØ§Ø±Ø© Ù„Ø§ ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ';
      }
      
      remainingPreview.textContent = fmt(rem);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠ
      if (noteText) {
        noteText.textContent = note;
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠ Ù„Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©
      if (paymentTypeHelp) {
        paymentTypeHelp.textContent = helpText;
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠ Ù„Ù„ØªÙ„Ù…ÙŠØ­
      const paymentTip = document.getElementById('payment_tip');
      if (paymentTip) {
        if (paymentType === 'Ø¯ÙØ¹Ø©') {
          paymentTip.textContent = 'Ø§Ù„Ø¯ÙØ¹Ø© ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ';
        } else if (paymentType === 'Ø±Ø³ÙˆÙ… Ø³ÙØ§Ø±Ø©') {
          paymentTip.textContent = 'Ø±Ø³ÙˆÙ… Ø§Ù„Ø³ÙØ§Ø±Ø© Ù„Ø§ ØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ';
        }
      }
      
      // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø©
      if (rem === 0) {
        remainingPreview.className = 'fs-5 fw-bold text-success ms-2';
      } else if (rem < baseRemaining * 0.3) {
        remainingPreview.className = 'fs-5 fw-bold text-warning ms-2';
      } else {
        remainingPreview.className = 'fs-5 fw-bold text-primary ms-2';
      }
    }
    
    amountInput.addEventListener('input', calculateRemaining);
    
    if (paymentTypeSelect) {
      paymentTypeSelect.addEventListener('change', calculateRemaining);
    }
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    calculateRemaining();
  }

  // ØªØ·Ø¨ÙŠÙ‚ Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
  document.addEventListener('DOMContentLoaded', function() {
    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯ÙØ¹
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
      const ratio = progressBar.getAttribute('data-width');
      progressBar.style.width = ratio + '%';
    }
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© Ù„Ù„Ø¬Ø¯ÙˆÙ„
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach((row, index) => {
      row.style.transition = 'all 0.3s ease';
      row.addEventListener('mouseenter', () => {
        row.style.transform = 'translateX(5px)';
        row.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
      });
      row.addEventListener('mouseleave', () => {
        row.style.transform = 'translateX(0)';
        row.style.boxShadow = 'none';
      });
    });
    
    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„Ø³Ø¨Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    const statusSelect = document.getElementById('new_status');
    const reasonField = document.getElementById('reason_field');
    const reasonTextarea = document.getElementById('rejection_reason');
    
    if (statusSelect && reasonField) {
      statusSelect.addEventListener('change', function() {
        if (this.value === 'Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰') {
          reasonField.style.display = 'block';
          reasonTextarea.setAttribute('required', 'required');
          reasonTextarea.focus();
        } else {
          reasonField.style.display = 'none';
          reasonTextarea.removeAttribute('required');
          reasonTextarea.value = '';
        }
      });
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
      if (statusSelect.value === 'Ø±ÙØ¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰') {
        reasonField.style.display = 'block';
        reasonTextarea.setAttribute('required', 'required');
      }
    }
  });
</script>

<!-- Modal Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙØ­Ø© -->
<div class="modal fade" id="fileViewerModal" tabindex="-1" aria-labelledby="fileViewerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="fileViewerModalLabel">
          <i class="fas fa-file me-2"></i>
          <span id="modalFileName">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div id="fileViewerContent" class="w-100">
          <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§ -->
        </div>
      </div>
      <div class="modal-footer">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>
            Ø¥ØºÙ„Ø§Ù‚
          </button>
          <a href="#" id="downloadFileBtn" class="btn btn-success" download>
            <i class="fas fa-download me-2"></i>
            ØªØ­Ù…ÙŠÙ„
          </a>
          <a href="#" id="openInNewTabBtn" class="btn btn-info" target="_blank">
            <i class="fas fa-external-link-alt me-2"></i>
            ÙØªØ­ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
<div class="modal fade" id="deadlineModal" tabindex="-1" aria-labelledby="deadlineModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="deadlineModalLabel">
          <i class="fas fa-calendar me-2"></i>
          Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="deadlineForm" method="post">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="deadline_start" class="form-label fw-bold">
                <i class="fas fa-calendar-plus me-2 text-success"></i>
                Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø¯Ø©
              </label>
              <input type="date" class="form-control" id="deadline_start" name="deadline_start" required>
            </div>
            <div class="col-md-6">
              <label for="deadline_end" class="form-label fw-bold">
                <i class="fas fa-calendar-times me-2 text-danger"></i>
                Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¯Ø©
              </label>
              <input type="date" class="form-control" id="deadline_end" name="deadline_end" required>
            </div>
            <div class="col-md-6">
              <label for="warning_days" class="form-label fw-bold">
                <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                Ø£ÙŠØ§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø¨ÙƒØ±
              </label>
              <input type="number" class="form-control" id="warning_days" name="warning_days" 
                     min="1" max="30" value="7" required>
              <div class="form-text">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</div>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">
                <i class="fas fa-info-circle me-2 text-info"></i>
                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø©
              </label>
              <div class="alert alert-info border-0">
                <div id="deadlineInfo">
                  <i class="fas fa-lightbulb me-1"></i>
                  Ø§Ø®ØªØ± Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¯Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>
          Ø¥Ù„ØºØ§Ø¡
        </button>
        <button type="submit" form="deadlineForm" class="btn btn-primary">
          <i class="fas fa-save me-2"></i>
          Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Modal -->
<script>
function viewFileInModal(filePath, fileName, fileType) {
  const modal = new bootstrap.Modal(document.getElementById('fileViewerModal'));
  const modalTitle = document.getElementById('modalFileName');
  const modalContent = document.getElementById('fileViewerContent');
  const downloadBtn = document.getElementById('downloadFileBtn');
  const openInNewTabBtn = document.getElementById('openInNewTabBtn');
  
  // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Modal
  modalTitle.textContent = fileName;
  
  // ØªØ­Ø¯ÙŠØ« Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  downloadBtn.href = `/uploads/${filePath}`;
  openInNewTabBtn.href = `/uploads/${filePath}`;
  
  // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚
  modalContent.innerHTML = '';
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø­Ø³Ø¨ Ù†ÙˆØ¹Ù‡
  if (fileType === 'pdf') {
    // Ø¹Ø±Ø¶ PDF
    const iframe = document.createElement('iframe');
    iframe.src = `/view_pdf/${filePath}`;
    iframe.style.width = '100%';
    iframe.style.height = '70vh';
    iframe.style.border = 'none';
    iframe.title = 'Ø¹Ø±Ø¶ PDF';
    modalContent.appendChild(iframe);
  } else if (fileType === 'image') {
    // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
    const img = document.createElement('img');
    img.src = `/view_image/${filePath}`;
    img.style.width = '100%';
    img.style.height = 'auto';
    img.style.maxHeight = '70vh';
    img.style.objectFit = 'contain';
    img.alt = fileName;
    modalContent.appendChild(img);
  } else if (fileType === 'document') {
    // Ø¹Ø±Ø¶ Ù…Ù„ÙØ§Øª Office
    const iframe = document.createElement('iframe');
    iframe.src = `/view_document/${filePath}`;
    iframe.style.width = '100%';
    iframe.style.height = '70vh';
    iframe.style.border = 'none';
    iframe.title = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù';
    modalContent.appendChild(iframe);
  } else {
    // Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ØŒ Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const downloadDiv = document.createElement('div');
    downloadDiv.className = 'text-center p-5';
    downloadDiv.innerHTML = `
      <i class="fas fa-file fa-4x text-muted mb-3"></i>
      <h5 class="text-muted">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª</h5>
      <p class="text-muted">Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</p>
    `;
    modalContent.appendChild(downloadDiv);
  }
  
  // Ø¹Ø±Ø¶ Modal
  modal.show();
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
function getFileType(filePath) {
  const extension = filePath.split('.').pop().toLowerCase();
  if (['pdf'].includes(extension)) return 'pdf';
  if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension)) return 'image';
  if (['doc', 'docx', 'xls', 'xlsx'].includes(extension)) return 'document';
  return 'other';
}

// Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
let currentDocumentId = null;

function setDeadline(docId) {
  currentDocumentId = docId;
  const modal = new bootstrap.Modal(document.getElementById('deadlineModal'));
  const form = document.getElementById('deadlineForm');
  const startInput = document.getElementById('deadline_start');
  const endInput = document.getElementById('deadline_end');
  const warningInput = document.getElementById('warning_days');
  
  // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  form.reset();
  
  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØ¨Ø¯Ø§ÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  const today = new Date().toISOString().split('T')[0];
  startInput.value = today;
  
  // ØªØ­Ø¯ÙŠØ« action Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
  form.action = `/client/{{ client.id }}/set_document_deadline/${docId}`;
  
  // Ø¹Ø±Ø¶ Modal
  modal.show();
  
  // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø©
  updateDeadlineInfo();
}

function editDeadline(docId, startDate, endDate, warningDays) {
  currentDocumentId = docId;
  const modal = new bootstrap.Modal(document.getElementById('deadlineModal'));
  const form = document.getElementById('deadlineForm');
  const startInput = document.getElementById('deadline_start');
  const endInput = document.getElementById('deadline_end');
  const warningInput = document.getElementById('warning_days');
  
  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  startInput.value = startDate;
  endInput.value = endDate;
  warningInput.value = warningDays;
  
  // ØªØ­Ø¯ÙŠØ« action Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
  form.action = `/client/{{ client.id }}/set_document_deadline/${docId}`;
  
  // Ø¹Ø±Ø¶ Modal
  modal.show();
  
  // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø©
  updateDeadlineInfo();
}

function updateDeadlineInfo() {
  const startInput = document.getElementById('deadline_start');
  const endInput = document.getElementById('deadline_end');
  const warningInput = document.getElementById('warning_days');
  const infoDiv = document.getElementById('deadlineInfo');
  
  if (startInput.value && endInput.value) {
    const start = new Date(startInput.value);
    const end = new Date(endInput.value);
    const warning = parseInt(warningInput.value) || 7;
    
    if (start >= end) {
      infoDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-1 text-warning"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©';
      return;
    }
    
    const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
    const warningDate = new Date(end);
    warningDate.setDate(warningDate.getDate() - warning);
    
    infoDiv.innerHTML = `
      <div><i class="fas fa-calendar me-1"></i> <strong>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„ÙƒÙ„ÙŠØ©:</strong> ${totalDays} ÙŠÙˆÙ…</div>
      <div><i class="fas fa-exclamation-triangle me-1"></i> <strong>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø¨ÙƒØ±:</strong> ${warningDate.toLocaleDateString('ar-EG')}</div>
      <div><i class="fas fa-clock me-1"></i> <strong>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¯Ø©:</strong> ${end.toLocaleDateString('ar-EG')}</div>
    `;
  } else {
    infoDiv.innerHTML = '<i class="fas fa-lightbulb me-1"></i> Ø§Ø®ØªØ± Ø¨Ø¯Ø§ÙŠØ© ÙˆÙ†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¯Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª';
  }
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
document.addEventListener('DOMContentLoaded', function() {
  const startInput = document.getElementById('deadline_start');
  const endInput = document.getElementById('deadline_end');
  const warningInput = document.getElementById('warning_days');
  
  if (startInput && endInput && warningInput) {
    startInput.addEventListener('change', updateDeadlineInfo);
    endInput.addEventListener('change', updateDeadlineInfo);
    warningInput.addEventListener('input', updateDeadlineInfo);
  }
});
</script>

{% endblock %}

